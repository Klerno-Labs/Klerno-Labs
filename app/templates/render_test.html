{% extends "base.html" %}

{% block title %}Render Deployment Test{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2>Render Deployment Test</h2>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <strong>Environment:</strong> {{ environment }}<br>
                <strong>Current Time:</strong> {{ current_time }}<br>
                <strong>Python Version:</strong> {{ python_version }}
            </div>
            
            <h3>Static Resources Test</h3>
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Logo via url_path_for</div>
                        <div class="card-body text-center">
                            <img src="{{ url_for('static', path='klerno-logo.png') }}" alt="Klerno Logo" style="max-width: 200px;" class="img-fluid">
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Logo via direct path (fallback)</div>
                        <div class="card-body text-center">
                            <img src="/static/klerno-logo.png" alt="Klerno Logo Direct" style="max-width: 200px;" class="img-fluid">
                        </div>
                    </div>
                </div>
            </div>
            
            <h3>System Information</h3>
            <div class="card mb-4">
                <div class="card-header">Environment Details</div>
                <div class="card-body">
                    <pre>{{ system_info | tojson(indent=2) }}</pre>
                </div>
            </div>
            
            <h3>API Integration Tests</h3>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header">Mock Transactions</div>
                        <div class="card-body">
                            <div id="transactions-data">Loading...</div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary" id="load-transactions">Load Transactions</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header">Mock Report</div>
                        <div class="card-body">
                            <div id="report-data">Loading...</div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-success" id="load-report">Load Report</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <h3>Error Handling Test</h3>
            <div class="card mb-4">
                <div class="card-header">Test Error Handling</div>
                <div class="card-body">
                    <p>Click the button below to trigger an error and test the error handling system:</p>
                    <button class="btn btn-danger" id="trigger-error">Trigger Error</button>
                    <div class="mt-3">
                        <div id="error-result" class="alert alert-secondary d-none">
                            Error response will appear here
                        </div>
                    </div>
                </div>
            </div>
            
            <h3>Environment Variables</h3>
            <div class="card mb-4">
                <div class="card-header">Environment Diagnostics</div>
                <div class="card-body">
                    <button class="btn btn-info" id="load-env">Load Environment Info</button>
                    <div id="env-data" class="mt-3">Click button to load environment details</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to handle API requests
    async function fetchAPI(url, elementId, formatFunc) {
        const element = document.getElementById(elementId);
        element.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
        
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const data = await response.json();
            element.innerHTML = formatFunc(data);
        } catch (error) {
            element.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            console.error('Fetch error:', error);
        }
    }
    
    // Format transactions
    function formatTransactions(data) {
        if (!data || data.length === 0) {
            return '<div class="alert alert-warning">No transactions found</div>';
        }
        
        let html = '<div class="table-responsive"><table class="table table-striped table-sm">';
        html += '<thead><tr><th>ID</th><th>Amount</th><th>Currency</th><th>Status</th></tr></thead><tbody>';
        
        data.forEach(tx => {
            html += `<tr>
                <td>${tx.id}</td>
                <td>${tx.amount}</td>
                <td>${tx.currency}</td>
                <td><span class="badge bg-success">${tx.status}</span></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        return html;
    }
    
    // Format report
    function formatReport(data) {
        if (!data) {
            return '<div class="alert alert-warning">No report data found</div>';
        }
        
        let html = `
            <div class="alert alert-info">
                <strong>Report ID:</strong> ${data.report_id}<br>
                <strong>Generated:</strong> ${new Date(data.generated_at).toLocaleString()}<br>
                <strong>Total Amount:</strong> ${data.total_amount} ${data.currency}<br>
                <strong>Transactions:</strong> ${data.transactions.length}
            </div>
        `;
        return html;
    }
    
    // Format environment data
    function formatEnvData(data) {
        if (!data) {
            return '<div class="alert alert-warning">No environment data found</div>';
        }
        
        let html = '<ul class="list-group">';
        html += `<li class="list-group-item"><strong>Python Version:</strong> ${data.python_version}</li>`;
        html += `<li class="list-group-item"><strong>Platform:</strong> ${data.platform}</li>`;
        html += `<li class="list-group-item"><strong>CWD:</strong> ${data.cwd}</li>`;
        html += `<li class="list-group-item"><strong>Static Files Path:</strong> ${data.static_files_path}</li>`;
        html += `<li class="list-group-item"><strong>Static Files Exist:</strong> ${data.static_files_exist}</li>`;
        
        if (data.static_files_content && data.static_files_content.length > 0) {
            html += `<li class="list-group-item"><strong>Static Files:</strong> <ul>`;
            data.static_files_content.forEach(file => {
                html += `<li>${file}</li>`;
            });
            html += `</ul></li>`;
        }
        
        html += `<li class="list-group-item"><strong>Templates Path:</strong> ${data.templates_path}</li>`;
        html += `<li class="list-group-item"><strong>Templates Exist:</strong> ${data.templates_exist}</li>`;
        html += `<li class="list-group-item"><strong>Render Test Template Exists:</strong> ${data.render_test_template_exists}</li>`;
        
        // Show environment variables
        if (data.env_vars) {
            html += `<li class="list-group-item">
                <strong>Environment Variables:</strong>
                <button class="btn btn-sm btn-primary float-end" onclick="document.getElementById('env-vars').classList.toggle('d-none')">
                    Toggle
                </button>
                <div id="env-vars" class="d-none mt-2">
                    <pre>${JSON.stringify(data.env_vars, null, 2)}</pre>
                </div>
            </li>`;
        }
        
        html += '</ul>';
        return html;
    }
    
    // Event listeners
    document.getElementById('load-transactions').addEventListener('click', () => {
        fetchAPI('/render-test/api/transactions', 'transactions-data', formatTransactions);
    });
    
    document.getElementById('load-report').addEventListener('click', () => {
        fetchAPI('/render-test/api/report', 'report-data', formatReport);
    });
    
    document.getElementById('load-env').addEventListener('click', () => {
        fetchAPI('/render-test/api/environment', 'env-data', formatEnvData);
    });
    
    document.getElementById('trigger-error').addEventListener('click', async () => {
        const resultElement = document.getElementById('error-result');
        resultElement.classList.remove('d-none');
        resultElement.innerHTML = '<div class="spinner-border text-danger" role="status"><span class="visually-hidden">Loading...</span></div>';
        
        try {
            const response = await fetch('/render-test/error');
            const data = await response.text();
            resultElement.innerHTML = `<div class="alert alert-success">Error handler worked! Response: ${response.status}</div>`;
        } catch (error) {
            resultElement.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    });
});
</script>
{% endblock %}