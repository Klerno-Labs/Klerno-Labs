<!doctype html>
<html lang="en" data-app="klerno-shell">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title or "Dashboard" }} — Klerno Labs</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#0b1020; --panel:#111831; --panel-2:#0f152c; --line:#1e2a52; --ink:#e8ecf3;
      --muted:#9aa9c6; --cta:#6c63ff; --primary:#6c63ff; --good:#2ecc71; --warn:#ffa940; --err:#ef4444;
      --radius:14px; --gap:14px; --pad:16px;
      --focus: 0 0 0 3px rgba(108,99,255,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--ink);
      -webkit-tap-highlight-color:transparent;
    }

    /* animated background */
    canvas#bg{position:fixed; inset:0; width:100%; height:100%; display:block; z-index:0}
    .vignette{
      position:fixed; inset:0; z-index:1; pointer-events:none;
      background:radial-gradient(1200px 600px at 70% 20%,transparent 0%,rgba(0,0,0,.35) 70%,rgba(0,0,0,.7) 100%);
      mix-blend-mode:multiply;
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:40;
      backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(180deg, rgba(0,0,0,.30), rgba(0,0,0,.00));
      border-bottom:1px solid var(--line);
    }
    .hdr{display:flex; align-items:center; gap:10px; padding:10px var(--pad); max-width:1100px; margin:0 auto}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--ink)}
    .brand .wordmark{height:28px; display:block; filter:drop-shadow(0 2px 10px rgba(108,99,255,.25))}
    @media (min-width:900px){ .brand .wordmark{ height:32px } }
    .spacer{flex:1}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; min-height:44px; border-radius:10px; border:1px solid var(--line);
      background:#151e3c; color:var(--ink); text-decoration:none; cursor:pointer}
    .btn.primary{background:var(--cta); border-color:#574bdb; color:white}
    .btn.ghost{background:transparent}
    .btn:focus-visible{ outline:none; box-shadow:var(--focus) }

    /* Status pill (connect) */
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);
      border-radius:999px;background:rgba(255,255,255,.06);color:var(--ink);cursor:pointer;font-weight:700;font-size:12px}
    .pill .dot{width:8px;height:8px;border-radius:50%;background:#a0a0a0;box-shadow:0 0 10px rgba(160,160,160,.5)}
    .pill--connected .dot{background:#34d399}
    .pill--connected{border-color:rgba(52,211,153,.35)}
    .pill--disconnected{opacity:.9}

    /* Shell: bottom tabs (mobile) -> left rail (desktop) */
    .shell{display:grid; gap:0; grid-template-areas:"main" "tabs"; grid-template-rows:1fr auto; min-height:calc(100dvh - 56px)}
    nav[role="tablist"]{
      grid-area:tabs; position:sticky; bottom:0; z-index:30; border-top:1px solid var(--line);
      background:var(--panel); display:grid; grid-template-columns:repeat(5,1fr);
    }
    .tab{
      appearance:none; border:0; margin:0; background:none; color:var(--muted);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:10px 6px; min-height:56px; cursor:pointer;
    }
    .tab[aria-selected="true"]{ color:var(--ink); font-weight:700 }
    .tab:focus-visible{ outline:none; box-shadow:inset 0 0 0 2px rgba(255,255,255,.06), var(--focus) }

    @media (min-width:920px){
      .shell{
        grid-template-columns:240px 1fr;
        grid-template-areas:"tabs main";
        grid-template-rows:1fr; gap:var(--gap);
        max-width:1200px; margin:0 auto; width:100%;
      }
      nav[role="tablist"]{
        position:sticky; top:calc(56px + 1px); align-self:start; height:calc(100dvh - 56px);
        border-top:0; border-right:1px solid var(--line); background:transparent;
        grid-template-columns:1fr; padding:var(--gap);
      }
      .tab{justify-content:flex-start; align-items:flex-start; padding:12px var(--pad); min-height:44px; border-radius:10px; margin-bottom:6px}
      .tab[aria-selected="true"]{ background:linear-gradient(0deg, rgba(108,99,255,.18), rgba(108,99,255,.18)); color:white }
    }

    main{ grid-area:main; padding:var(--gap); position:relative; z-index:2 }

    /* Generic surface blocks (your existing cards) */
    .card{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:16px}
    .row{display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin:18px 0}
    @media (max-width:920px){ .row{grid-template-columns:1fr} }
    .kpi{font-size:28px; font-weight:700; letter-spacing:-.02em}
    .muted{color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .grid2{display:grid; grid-template-columns:2fr 1fr; gap:14px}
    @media (max-width:920px){ .grid2{grid-template-columns:1fr} }
    canvas{width:100%; height:220px; display:block}
    table{width:100%; border-collapse:collapse; background:var(--panel); border:1px solid var(--line); border-radius:12px; overflow:hidden}
    th,td{padding:10px 12px; border-bottom:1px solid var(--line); font-size:14px}
    th{background:#0f1630; text-align:left; color:#cbd5f7}
    tr:last-child td{border-bottom:none}
    .tag{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); color:#cfe1ff}
    .ok{color:var(--good)} .warn{color:var(--warn)}
    .note{font-size:12px; color:var(--muted)}
    .right{display:flex; align-items:center; gap:10px}

    /* Panels (tab content) */
    [role="tabpanel"][hidden]{ display:none }

    /* Explore segmented control */
    .seg{ display:inline-flex; border:1px solid var(--line); border-radius:999px; padding:4px; background:var(--panel-2) }
    .seg [role="tab"]{
      appearance:none; background:none; border:0; margin:0; cursor:pointer;
      padding:8px 12px; min-height:40px; min-width:72px; border-radius:999px; color:var(--muted)
    }
    .seg [role="tab"][aria-selected="true"]{ background:var(--primary); color:#fff }

    /* Skeletons & toasts */
    .skeleton{ position:relative; overflow:hidden; background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06)); background-size:200% 100% }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    @media (prefers-reduced-motion: no-preference){ .skeleton{ animation: shimmer 1.1s linear infinite } }
    .srow{ height:16px; border-radius:6px; margin:6px 0 }
    .toasts{position:fixed; right:16px; bottom:16px; display:grid; gap:8px; z-index:70}
    .toast{padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:rgba(0,0,0,.6); color:#fff; max-width:min(90vw,360px)}
    .toast.ok{border-color:rgba(52,211,153,.4)} .toast.err{border-color:rgba(239,68,68,.5)} .toast.warn{border-color:rgba(255,169,64,.5)}

    /* Modal (Connect) */
    .modal.hidden{display:none}
    .modal{position:fixed;inset:0;z-index:60}
    .modal__scrim{position:absolute;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px)}
    .modal__card{position:relative;max-width:520px;margin:8vh auto;background:var(--panel);border:1px solid var(--line);
      border-radius:16px;padding:0;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .modal__hdr{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--line)}
    .modal__body{padding:16px 18px;display:grid;gap:14px}
    .modal__ftr{padding:14px 18px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:10px}
    .modal__x{border:0;background:transparent;color:var(--ink);font-size:22px;cursor:pointer}
    .frow{display:grid;gap:6px}
    .frow input,.frow select{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1020;color:var(--ink)}
    .grid2small{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .hint{color:var(--muted);font-size:12px}

    /* Command menu (stub) */
    .cmdk[hidden]{ display:none }
    .cmdk{
      position:fixed; inset:0; z-index:90; display:grid; place-items:center;
      background:rgba(0,0,0,.45); backdrop-filter: blur(6px);
    }
    .cmdk .box{
      width:min(680px, 92vw); border:1px solid var(--line); border-radius:12px; background:var(--panel);
      padding:10px; box-shadow:0 20px 60px rgba(0,0,0,.35)
    }
    .cmdk input{ width:100%; padding:12px; border-radius:10px; border:1px solid var(--line); background:#0b1020; color:var(--ink) }

    /* Admin visibility */
    .tab--admin{ display:none }
    body[data-role="admin"] .tab--admin{ display:flex }
  </style>
</head>
<body data-role="" data-active="">
  <!-- animated background -->
  <canvas id="bg" aria-hidden="true"></canvas>
  <div class="vignette" aria-hidden="true"></div>

  <div class="app">
    <header>
      <div class="hdr">
        <a class="brand" href="#home" aria-label="Klerno Home">
          <img class="wordmark" src="{{ url_path_for('static', path='klerno-wordmark.png') }}" alt="Klerno Labs">
        </a>
        <div class="spacer"></div>

        <!-- Top actions -->
        <a class="btn" href="/alerts-ui">🚨 Alerts</a>
        <a class="btn" href="/docs" target="_blank" rel="noopener">📜 API</a>

        <!-- Status pill (opens Connect modal) -->
        <button id="statusPill" class="pill pill--disconnected" type="button" aria-haspopup="dialog" aria-expanded="false">
          <span class="dot" aria-hidden="true"></span> Not connected
        </button>

        <!-- Admin button (only visible for admins) -->
        <a id="adminTopBtn" class="btn ghost tab--admin" href="#admin" aria-hidden="true">Admin</a>

        <!-- Command + Profile -->
        <button id="cmd" class="btn" type="button" title="Command menu (⌘/Ctrl+K)">⌘K</button>
        <button id="profileBtn" class="btn" type="button" onclick="location.hash='#profile'">Profile</button>
      </div>
    </header>

    <div class="shell">
      <!-- Tablist -->
      <nav id="tabs" role="tablist" aria-label="Primary">
        <button id="tab-home" class="tab" role="tab" aria-controls="panel-home" aria-selected="false" tabindex="-1">Home</button>
        <button id="tab-explore" class="tab" role="tab" aria-controls="panel-explore" aria-selected="false" tabindex="-1">Explore</button>
        <button id="tab-create" class="tab" role="tab" aria-controls="panel-create" aria-selected="false" tabindex="-1">Create</button>
        <button id="tab-alerts" class="tab" role="tab" aria-controls="panel-alerts" aria-selected="false" tabindex="-1">Alerts</button>
        <button id="tab-profile" class="tab" role="tab" aria-controls="panel-profile" aria-selected="false" tabindex="-1">Profile</button>
        <button id="tab-admin" class="tab tab--admin" role="tab" aria-controls="panel-admin" aria-selected="false" tabindex="-1">Admin</button>
      </nav>

      <main id="main" tabindex="-1">
        <!-- HOME (your existing dashboard content) -->
        <section id="panel-home" role="tabpanel" aria-labelledby="tab-home" hidden>
          <!-- KPIs -->
          <div class="row">
            <div class="card">
              <div class="muted">Total processed</div>
              <div class="kpi" id="kpiTotal">—</div>
            </div>
            <div class="card">
              <div class="muted">Alerts ≥ threshold</div>
              <div class="kpi" id="kpiAlerts">—</div>
            </div>
            <div class="card">
              <div class="muted">Average risk <small id="kpiAvgDelta" class="muted"></small></div>
              <div class="kpi" id="kpiAvg">—</div>
            </div>
          </div>

          <div class="grid2">
            <!-- mini chart -->
            <div class="card">
              <div class="muted" style="margin-bottom:8px;">Average risk by day</div>
              <canvas id="chartRisk"></canvas>
              <div class="note">Simple canvas chart from <code>/metrics-ui.series_by_day</code>.</div>
            </div>

            <!-- categories -->
            <div class="card">
              <div class="muted" style="margin-bottom:8px;">Top categories</div>
              <div id="cats">—</div>
            </div>
          </div>

          <div style="height:14px"></div>

          <!-- quick actions -->
          <div class="card">
            <div class="muted" style="margin-bottom:8px;">Quick actions</div>
            <div class="actions">
              <a class="btn" id="fetchXRPL">⚡ Fetch XRPL (demo)</a>
              <a class="btn" id="analyzeSample">🧪 Analyze sample</a>
              <a class="btn" id="exportCsv">⬇️ Export CSV</a>
              <button class="btn primary" id="btnLoadDemo" type="button">✨ Load demo data</button>
            </div>
            <div class="note" style="margin-top:8px">
              These run using your signed-in session (no API key needed).
            </div>
          </div>

          <div style="height:14px"></div>

          <!-- recent high-risk -->
          <div class="card">
            <div class="muted" style="margin-bottom:8px;">Recent high-risk (preview)</div>
            <table>
              <thead>
                <tr>
                  <th>Time</th><th>From → To</th><th>Amount</th><th>Category</th><th>Risk</th>
                </tr>
              </thead>
              <tbody id="tblRecent">
                <tr><td colspan="5" class="muted">loading…</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- EXPLORE -->
        <section id="panel-explore" role="tabpanel" aria-labelledby="tab-explore" hidden>
          <div class="card" style="margin-bottom:14px">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <h2 style="margin:0">Explore</h2>
              <div id="seg" class="seg" role="tablist" aria-label="Explore modes">
                <button role="tab" aria-selected="true" tabindex="0" data-mode="explore">Explore</button>
                <button role="tab" aria-selected="false" tabindex="-1" data-mode="browse">Browse</button>
                <button role="tab" aria-selected="false" tabindex="-1" data-mode="projects">Projects</button>
              </div>
            </div>
            <p class="muted" style="margin:8px 0 0">Switch modes to view different discovery surfaces.</p>
          </div>

          <div class="card" data-explore="explore">
            <h3>Suggestions</h3>
            <div class="skeleton srow" style="width:60%"></div>
            <div class="skeleton srow" style="width:80%"></div>
            <div class="skeleton srow" style="width:40%"></div>
            <!-- TODO: wire recommenders -->
          </div>

          <div class="card" data-explore="browse" hidden>
            <h3>Browse</h3>
            <div class="skeleton srow" style="width:90%"></div>
            <div class="skeleton srow" style="width:70%"></div>
            <!-- TODO: pagination/sorting -->
          </div>

          <div class="card" data-explore="projects" hidden>
            <h3>Projects</h3>
            <div class="skeleton srow" style="width:75%"></div>
            <div class="skeleton srow" style="width:55%"></div>
            <!-- TODO: projects grid -->
          </div>
        </section>

        <!-- CREATE -->
        <section id="panel-create" role="tabpanel" aria-labelledby="tab-create" hidden>
          <div class="card">
            <h2 style="margin-top:0">Create</h2>
            <p class="muted">Start something new. Nothing here yet.</p>
            <div class="skeleton srow" style="width:90%"></div>
            <div class="skeleton srow" style="width:70%"></div>
            <div class="skeleton srow" style="width:50%"></div>
          </div>
        </section>

        <!-- ALERTS -->
        <section id="panel-alerts" role="tabpanel" aria-labelledby="tab-alerts" hidden>
          <div class="card">
            <h2 style="margin-top:0">Alerts</h2>
            <p class="muted">This tab can host live alerts (WebSocket) and filters.</p>
            <div class="skeleton srow" style="width:80%"></div>
            <div class="skeleton srow" style="width:60%"></div>
          </div>
        </section>

        <!-- PROFILE -->
        <section id="panel-profile" role="tabpanel" aria-labelledby="tab-profile" hidden>
          <div class="card">
            <h2 style="margin-top:0">Profile</h2>
            <p class="muted">Signed in as <em id="meEmail">—</em>. Role: <code id="meRole">—</code>.</p>
            <p class="note">Open the “Connect” pill (top-right) to save your x-api-key, risk threshold, and date range.</p>
          </div>

          <div class="grid2">
            <section class="card"><h3>Account</h3><p class="muted">Manage your account info.</p></section>
            <section class="card"><h3>Preferences</h3><p class="muted">App preferences & appearance.</p></section>
            <section class="card"><h3>Privacy & Security</h3><p class="muted">Control access and security.</p></section>
            <section class="card"><h3>Billing</h3><p class="muted">Your plan & invoices.</p></section>
            <section class="card"><h3>Help</h3><p class="muted">Docs, support & feedback.</p></section>
          </div>
        </section>

        <!-- ADMIN (visible only for admin) -->
        <section id="panel-admin" role="tabpanel" aria-labelledby="tab-admin" hidden>
          <div class="card">
            <h2 style="margin-top:0">Admin</h2>
            <p class="muted">Admin tools. Restricted to administrators.</p>
            <div class="grid2">
              <div class="card"><strong>Users</strong><div class="skeleton srow" style="width:80%"></div></div>
              <div class="card"><strong>System</strong><div class="skeleton srow" style="width:60%"></div></div>
            </div>
            <!-- TODO: guard server-side, list users, feature flags, email tests -->
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Connect / Settings modal -->
  <div id="connectModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="connectTitle">
    <div class="modal__scrim" data-close></div>
    <div class="modal__card">
      <header class="modal__hdr">
        <h3 id="connectTitle">Connect to Klerno API</h3>
        <button class="modal__x" type="button" title="Close" aria-label="Close" data-close>×</button>
      </header>

      <div class="modal__body">
        <label class="frow">
          <span>x-api-key</span>
          <input id="inpKey" type="password" placeholder="Paste your API key (optional)" autocomplete="off" />
        </label>

        <div class="grid2small">
          <label class="frow">
            <span>Risk threshold</span>
            <input id="inpThresh" type="number" min="0" max="1" step="0.01" placeholder="0.75" />
          </label>
          <label class="frow">
            <span>Time range (days)</span>
            <select id="selRange">
              <option value="7">Last 7 days</option>
              <option value="30">Last 30 days</option>
              <option value="1">Last 24 hours</option>
            </select>
          </label>
        </div>

        <p class="hint">Saved to your account so they persist across sessions.</p>
      </div>

      <footer class="modal__ftr">
        <button class="btn" data-close>Cancel</button>
        <button id="btnConnect" class="btn primary">Save</button>
      </footer>
    </div>
  </div>

  <!-- Command menu (stub) -->
  <div id="cmdk" class="cmdk" hidden>
    <div class="box" role="dialog" aria-modal="true" aria-labelledby="cmdk-title">
      <h3 id="cmdk-title" style="margin:6px 8px" class="muted">Command Menu</h3>
      <input id="cmdk-input" type="text" placeholder="Type a command… (stub)" autocomplete="off" />
      <p class="hint">TODO: wire actions (navigate, search, new item…). Press Esc to close.</p>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>

  <script>
  (function(){
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];

    // ---- Elements ----------------------------------------------------------
    const pill = $('#statusPill');
    const modal = $('#connectModal');
    const btnConnect = $('#btnConnect');
    const inpKey = $('#inpKey');
    const inpThresh = $('#inpThresh');
    const selRange = $('#selRange');
    const toasts = $('#toasts');
    const tabs = $$('#tabs [role="tab"]');
    const panels = $$('[role="tabpanel"]');
    const body = document.body;

    // ---- State -------------------------------------------------------------
    const state = {
      settings: {},
      connected: false,
      metrics: null,
      refreshHandle: null,
      me: null
    };

    // ---- Toasts ------------------------------------------------------------
    function toast(msg, type='ok', ms=2400){
      const el = document.createElement('div');
      el.className = 'toast ' + type;
      el.textContent = msg;
      toasts.appendChild(el);
      setTimeout(()=>{ el.remove(); }, ms);
    }

    // ---- Connect Modal -----------------------------------------------------
    function openModal(){
      modal.classList.remove('hidden');
      modal.querySelector('[data-close]').focus();
      inpKey.value = ''; // never reveal stored key
      inpThresh.value = state.settings.risk_threshold ?? '';
      selRange.value = (state.settings.time_range_days ?? 7).toString();
      pill.setAttribute('aria-expanded', 'true');
    }
    function closeModal(){ modal.classList.add('hidden'); pill.setAttribute('aria-expanded', 'false'); }
    modal.addEventListener('click', (e) => { if (e.target.matches('[data-close], .modal__scrim')) closeModal(); });
    pill?.addEventListener('click', openModal);
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal(); });

    // ---- Settings I/O (session) -------------------------------------------
    async function loadSettings(){
      try{
        const r = await fetch('/me/settings', {credentials:'include'});
        if(!r.ok) throw 0;
        state.settings = await r.json();
      }catch{ state.settings = {}; }
    }
    async function saveSettings(patch){
      const merged = {...state.settings, ...patch};
      const r = await fetch('/me/settings', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify(patch)
      });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok || j.ok === false) throw new Error(j.error || 'save failed');
      state.settings = j.settings || merged;
      return state.settings;
    }

    // ---- /me (set role -> controls Admin visibility) ----------------------
    async function loadMe(){
      try{
        const r = await fetch('/me', {credentials:'include'});
        if(!r.ok) throw 0;
        state.me = await r.json();
        body.dataset.role = (state.me.role || 'viewer');
        $('#meEmail').textContent = state.me.email || '—';
        $('#meRole').textContent = state.me.role || '—';
      }catch{
        state.me = null;
        body.dataset.role = '';
      }
    }

    // ---- Status pill -------------------------------------------------------
    function setPill(connected, subtitle){
      state.connected = !!connected;
      pill.classList.toggle('pill--connected', connected);
      pill.classList.toggle('pill--disconnected', !connected);
      pill.innerHTML = `<span class="dot" aria-hidden="true"></span> ${connected ? 'Connected' : 'Not connected'}${subtitle? ' • '+subtitle:''}`;
    }

    // ---- Painters ----------------------------------------------------------
    function fmt(n){ return Intl.NumberFormat().format(n); }
    function paintKPIs(m){
      const elTotal = $('#kpiTotal');
      const elAlerts = $('#kpiAlerts');
      const elAvg = $('#kpiAvg');
      if (elTotal) elTotal.textContent = fmt(m.total || 0);
      if (elAlerts) elAlerts.textContent = fmt(m.alerts || 0);
      if (elAvg) elAvg.textContent = (m.avg_risk ?? 0).toFixed(3);

      const s = m.series_by_day || [];
      const elDelta = $('#kpiAvgDelta');
      if (s.length >= 2 && elDelta) {
        const last = +s[s.length-1].avg_risk || 0;
        const prev = +s[s.length-2].avg_risk || 0;
        const delta = (last - prev) / (prev || 1) * 100;
        elDelta.textContent = ' • ' + (delta>=0? '▲':'▼') + Math.abs(delta).toFixed(1) + '%';
      } else if (elDelta) {
        elDelta.textContent = '';
      }

      // categories
      const catsDiv = $('#cats');
      if (catsDiv){
        const cats = Object.entries(m.categories || {}).sort((a,b)=>b[1]-a[1]).slice(0,6);
        catsDiv.innerHTML = cats.length
          ? cats.map(([k,v])=>`<span class="tag">${k} · ${v}</span>`).join(' ')
          : '<span class="muted">none</span>';
      }
    }

    function paintChart(series){
      const cv = $('#chartRisk'); if(!cv) return;
      const dpr = Math.min(window.devicePixelRatio||1,2);
      const parent = cv.parentElement;
      const w = parent.clientWidth, h = 220;
      cv.width = Math.floor(w*dpr); cv.height = Math.floor(h*dpr);
      cv.style.width = w+'px'; cv.style.height = h+'px';
      const ctx = cv.getContext('2d'); ctx.scale(dpr,dpr);

      if(!series.length){
        ctx.fillStyle='rgba(255,255,255,.45)'; ctx.fillText('No data yet', 16, 24); return;
      }
      const xs = series.map(d => new Date(d.date).getTime());
      const ys = series.map(d => +d.avg_risk || 0);
      const minX=Math.min(...xs), maxX=Math.max(...xs);
      const minY=Math.min(0, ...ys), maxY=Math.max(1, ...ys);
      const pad=16, top=10, bottom=28;
      const iw = w - pad*2, ih = h - top - bottom;
      const X = t => pad + ((t-minX)/(maxX-minX || 1))*iw;
      const Y = v => top + ih - ((v-minY)/(maxY-minY || 1))*ih;

      const grad = ctx.createLinearGradient(0, top, 0, top+ih);
      grad.addColorStop(0,'rgba(123,108,255,.45)'); grad.addColorStop(1,'rgba(123,108,255,0)');
      ctx.beginPath(); ctx.moveTo(X(xs[0]), Y(ys[0]));
      for(let i=1;i<xs.length;i++) ctx.lineTo(X(xs[i]), Y(ys[i]));
      ctx.lineTo(X(xs[xs.length-1]), top+ih); ctx.lineTo(X(xs[0]), top+ih); ctx.closePath();
      ctx.fillStyle = grad; ctx.fill();

      ctx.beginPath(); ctx.moveTo(X(xs[0]), Y(ys[0]));
      for(let i=1;i<xs.length;i++) ctx.lineTo(X(xs[i]), Y(ys[i]));
      ctx.strokeStyle='rgba(160,200,255,.9)'; ctx.lineWidth=2; ctx.stroke();
    }

    async function loadRecentHighRisk(){
      const r = await fetch('/alerts-ui/data?limit=50', { credentials:'include' });
      const tbody = $('#tblRecent'); if(!tbody) return;
      if(!r.ok){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Unauthorized for alerts preview</td></tr>`;
        return;
      }
      const data = await r.json();
      const items = (data.items||[]).slice(0,50);
      if (!items.length){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">No alerts yet</td></tr>`;
        return;
      }
      tbody.innerHTML = items.map(it=>{
        const t  = (it.timestamp||'').toString().replace('T',' ').slice(0,19);
        const ft = `${(it.from_addr||'').slice(0,6)}… → ${(it.to_addr||'').slice(0,6)}…`;
        const amt= `${(+it.amount||0).toFixed(2)} ${(it.symbol||'')}`;
        const cat= it.category || 'unknown';
        const risk = Number(it.risk_score ?? it.score ?? 0).toFixed(3);
        const raw  = Number(it.risk_score ?? it.score ?? 0);
        const cls  = raw >= (state.settings.risk_threshold || 0.75) ? 'warn' : 'ok';
        return `<tr>
          <td>${t}</td>
          <td>${ft}</td>
          <td>${amt}</td>
          <td><span class="tag">${cat}</span></td>
          <td class="${cls}">${risk}</td>
        </tr>`;
      }).join('');
    }

    // ---- Metrics + connectivity (session-based) ----------------------------
    async function loadMetricsOnce(){
      try{
        const days = state.settings.time_range_days || 7;
        const r = await fetch(`/metrics-ui?days=${encodeURIComponent(days)}`, { credentials:'include' });
        if(!r.ok) throw 0;
        const data = await r.json();
        state.metrics = data;
        setPill(true, days+'d');               // mark Connected only on success
        paintKPIs(data);
        paintChart(data.series_by_day || []);
        await loadRecentHighRisk();
      }catch{
        setPill(false);
      }
    }

    function startAutoRefresh(){
      if (state.refreshHandle) clearInterval(state.refreshHandle);
      state.refreshHandle = setInterval(loadMetricsOnce, 15000);
      document.addEventListener('visibilitychange', () => { if (!document.hidden) loadMetricsOnce(); });
    }

    // ---- Save (Connect) handler -------------------------------------------
    btnConnect.addEventListener('click', async ()=>{
      const patch = {
        ...(inpKey.value.trim() ? { x_api_key: inpKey.value.trim() } : {}),
        risk_threshold: inpThresh.value ? +inpThresh.value : undefined,
        time_range_days: selRange.value ? +selRange.value : undefined
      };
      try{
        const saved = await saveSettings(patch);
        closeModal();
        toast('Saved ✓');
        setPill(true, (saved.time_range_days||7)+'d');
        await loadMetricsOnce();
      }catch{ toast('Save failed', 'err'); }
    });

    // ---- Quick actions (session-protected UI API) --------------------------
    $('#fetchXRPL')?.addEventListener('click', async ()=>{
      const acct = prompt('XRPL account to fetch (e.g. rEb8TK3gBgk5...)','rEb8TK3gBgk5auZkwc6sHnwrGVJH8DuaLh');
      if (!acct) return;
      const url = `/uiapi/integrations/xrpl/fetch_and_save?account=${encodeURIComponent(acct)}&limit=10`;
      const r = await fetch(url, { method:'POST', credentials:'include' });
      toast(r.ok ? 'Fetched & saved ✓' : 'Fetch failed', r.ok ? 'ok' : 'err');
      await loadMetricsOnce();
    });
    $('#analyzeSample')?.addEventListener('click', async ()=>{
      const r = await fetch('/uiapi/analyze/sample', { method:'POST', credentials:'include' });
      toast(r.ok ? 'Sample analyzed ✓' : 'Analyze failed', r.ok ? 'ok' : 'err');
      await loadMetricsOnce();
    });
    $('#exportCsv')?.addEventListener('click', ()=>{
      window.open('/uiapi/export/csv/download', '_blank');
    });
    $('#btnLoadDemo')?.addEventListener('click', async ()=>{
      try{
        const r = await fetch('/uiapi/analyze/sample', { method:'POST', credentials:'include' });
        if(!r.ok) throw 0;
        toast('Demo data loaded ✓');
        await loadMetricsOnce();
      }catch{ toast('Could not load demo data', 'err'); }
    });

    // ---- Tabs: roving tabindex + keyboard + router ------------------------
    function setSelected(tab){
      const target = tab.getAttribute('aria-controls');
      tabs.forEach(t=>{
        const sel = (t===tab);
        t.setAttribute('aria-selected', sel);
        t.tabIndex = sel ? 0 : -1;
      });
      panels.forEach(p => p.hidden = (p.id !== target));
      tab.focus({preventScroll:true});
      const hash = '#' + (tab.id.replace(/^tab-/, ''));
      if (location.hash !== hash) history.replaceState(null, '', hash);
      document.title = 'Klerno • ' + tab.textContent;
      body.dataset.active = hash.slice(1);
      // Guard admin client-side (server should also guard)
      if (hash === '#admin' && body.dataset.role !== 'admin') {
        toast('Admins only', 'warn');
        history.replaceState(null, '', '#home');
        selectTabById('tab-home');
      }
    }
    function selectTabById(id){ const tab = $('#'+id); if (tab) setSelected(tab); }
    function indexOfTab(el){ return tabs.indexOf(el); }
    function moveFocus(current, delta){
      const i = indexOfTab(current);
      if (i < 0) return;
      const next = (i + delta + tabs.length) % tabs.length;
      tabs[next].focus();
    }
    $('#tabs').addEventListener('keydown', (e)=>{
      const current = document.activeElement;
      if (!tabs.includes(current)) return;
      switch(e.key){
        case 'ArrowRight':
        case 'ArrowDown': e.preventDefault(); moveFocus(current, +1); break;
        case 'ArrowLeft':
        case 'ArrowUp':   e.preventDefault(); moveFocus(current, -1); break;
        case 'Home':      e.preventDefault(); tabs[0].focus(); break;
        case 'End':       e.preventDefault(); tabs[tabs.length-1].focus(); break;
        case ' ':
        case 'Enter':     e.preventDefault(); setSelected(current); break;
      }
    });
    tabs.forEach(t => t.addEventListener('click', ()=> setSelected(t)));

    // ---- Explore segmented control ----------------------------------------
    const seg = $('#seg');
    if (seg){
      const segTabs = $$('[role="tab"]', seg);
      const panelsByMode = $$('[data-explore]');
      function showMode(mode){ panelsByMode.forEach(p => p.hidden = (p.getAttribute('data-explore') !== mode)); }
      function segSelect(btn){ segTabs.forEach(b=>{ const sel = b===btn; b.setAttribute('aria-selected', sel); b.tabIndex = sel?0:-1; }); showMode(btn.dataset.mode); }
      seg.addEventListener('click', (e)=>{ const btn = e.target.closest('[role="tab"]'); if(!btn) return; segSelect(btn); });
      seg.addEventListener('keydown', (e)=>{
        const current = document.activeElement; if(!segTabs.includes(current)) return;
        if (e.key==='ArrowRight' || e.key==='ArrowDown'){ e.preventDefault(); segTabs[(segTabs.indexOf(current)+1)%segTabs.length].focus(); }
        else if (e.key==='ArrowLeft' || e.key==='ArrowUp'){ e.preventDefault(); segTabs[(segTabs.indexOf(current)-1+segTabs.length)%segTabs.length].focus(); }
        else if (e.key===' ' || e.key==='Enter'){ e.preventDefault(); segSelect(current); }
      });
    }

    // ---- Router (#home, #explore, #create, #alerts, #profile, #admin) -----
    const valid = new Set(['home','explore','create','alerts','profile','admin']);
    function routeFromHash(){
      const raw = (location.hash || '#home').replace('#','').toLowerCase().trim();
      const name = valid.has(raw) ? raw : 'home';
      if (name==='admin' && body.dataset.role !== 'admin'){ toast('Admins only', 'warn'); history.replaceState(null, '', '#home'); selectTabById('tab-home'); return; }
      selectTabById('tab-' + name);
    }
    window.addEventListener('hashchange', routeFromHash);

    // ---- Command menu (stub) ----------------------------------------------
    const cmdBtn = $('#cmd'), cmdk = $('#cmdk'), cmdInput = $('#cmdk-input');
    function openCmd(){ cmdk.hidden = false; cmdInput.value=''; cmdInput.focus(); }
    function closeCmd(){ cmdk.hidden = true; $('#main').focus({preventScroll:true}); }
    cmdBtn.addEventListener('click', openCmd);
    document.addEventListener('keydown', (e)=>{
      const meta = e.metaKey || e.ctrlKey;
      if (meta && e.key.toLowerCase()==='k'){ e.preventDefault(); openCmd(); }
      if (e.key==='Escape' && !cmdk.hidden){ e.preventDefault(); closeCmd(); }
    });
    cmdk.addEventListener('click', (e)=>{ if (e.target === cmdk) closeCmd(); });

    // ---- Boot --------------------------------------------------------------
    (async function boot(){
      // 1) Hydrate role (controls admin visibility)
      await loadMe();

      // 2) Load settings, then metrics (only set "Connected" on success)
      await loadSettings();
      await loadMetricsOnce();

      // 3) Start auto-refresh
      startAutoRefresh();

      // 4) Route to current hash (default: #home)
      routeFromHash();
    })();

    // ---- Background animation (unchanged) ---------------------------------
    (function(){
      const bg = document.getElementById('bg'); if(!bg) return;
      const ctx = bg.getContext('2d');
      let W,H,DPR=Math.min(window.devicePixelRatio||1,2), P=[];
      const rnd=n=>Math.random();
      function resize(){
        W=bg.width = Math.floor(innerWidth*DPR);
        H=bg.height= Math.floor(innerHeight*DPR);
        bg.style.width = innerWidth+'px';
        bg.style.height= innerHeight+'px';
        const n=Math.floor((W*H)/(90_000*DPR));
        P = Array.from({length:n},()=>({ x:rnd()*W, y:rnd()*H, vx:(rnd()-.5)*.35*DPR, vy:(rnd()-.5)*.35*DPR }));
      }
      function step(){
        ctx.clearRect(0,0,W,H);
        const g=ctx.createLinearGradient(0,0,W,H);
        g.addColorStop(0,'rgba(123,108,255,.10)'); g.addColorStop(.5,'rgba(0,225,255,.08)'); g.addColorStop(1,'rgba(255,255,255,.05)');
        ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
        ctx.fillStyle='rgba(255,255,255,.45)';
        for(const p of P){
          p.x+=p.vx; p.y+=p.vy;
          if(p.x<0||p.x>W) p.vx*=-1;
          if(p.y<0||p.y>H) p.vy*=-1;
          ctx.beginPath(); ctx.arc(p.x,p.y,1.3*DPR,0,Math.PI*2); ctx.fill();
        }
        ctx.strokeStyle='rgba(200,220,255,.11)';
        for(let i=0;i<P.length;i++){
          const a=P[i];
          for(let j=i+1;j<P.length;j++){
            const b=P[j],dx=a.x-b.x,dy=a.y-b.y,d2=dx*dx+dy*dy;
            if(d2<18000*DPR){
              ctx.globalAlpha=1-d2/(18000*DPR);
              ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
            }
          }
        }
        ctx.globalAlpha=1;
        requestAnimationFrame(step);
      }
      resize(); requestAnimationFrame(step); addEventListener('resize', resize);
    })();
  })();
  </script>
</body>
</html>
