<!doctype html>
<html lang="en" data-app="klerno-shell">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title or "Dashboard" }} ‚Äî Klerno Labs</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#0b1020; --panel:#111831; --panel-2:#0f152c; --line:#1e2a52; --ink:#e8ecf3;
      --muted:#9aa9c6; --cta:#6c63ff; --primary:#6c63ff; --good:#2ecc71; --warn:#ffa940; --err:#ef4444;
      --radius:14px; --gap:14px; --pad:16px; --focus: 0 0 0 3px rgba(108,99,255,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--ink);
      -webkit-tap-highlight-color:transparent;
    }

    /* background */
    canvas#bg{position:fixed; inset:0; width:100%; height:100%; display:block; z-index:0}
    .vignette{
      position:fixed; inset:0; z-index:1; pointer-events:none;
      background:radial-gradient(1200px 600px at 70% 20%,transparent 0%,rgba(0,0,0,.35) 70%,rgba(0,0,0,.7) 100%);
      mix-blend-mode:multiply;
    }

    /* top header */
    header{
      position:sticky; top:0; z-index:40;
      backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(180deg, rgba(0,0,0,.30), rgba(0,0,0,.00));
      border-bottom:1px solid var(--line);
    }
    .hdr{display:flex; align-items:center; gap:10px; padding:10px var(--pad); max-width:1100px; margin:0 auto}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--ink)}
    .brand .wordmark{height:28px; display:block; filter:drop-shadow(0 2px 10px rgba(108,99,255,.25))}
    @media (min-width:900px){ .brand .wordmark{ height:32px } }
    .spacer{flex:1}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; min-height:44px; border-radius:10px; border:1px solid var(--line);
      background:#151e3c; color:var(--ink); text-decoration:none; cursor:pointer}
    .btn.ghost{background:transparent}
    .btn.primary{background:var(--cta); border-color:#574bdb; color:white}
    .btn:focus-visible{ outline:none; box-shadow:var(--focus) }

    /* TOP TABS */
    .tabsbar{
      position:sticky; top:56px; z-index:35; border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.25); backdrop-filter: blur(6px);
    }
    .tabs{
      display:flex; gap:6px; max-width:1100px; margin:0 auto; padding:8px var(--pad);
      overflow:auto;
    }
    .tab{
      appearance:none; border:1px solid var(--line); background:var(--panel);
      color:var(--muted); padding:10px 12px; border-radius:10px; cursor:pointer;
      white-space:nowrap;
    }
    .tab[aria-selected="true"]{ color:#fff; background:linear-gradient(0deg, rgba(108,99,255,.18), rgba(108,99,255,.18)) }
    .tab:focus-visible{ outline:none; box-shadow:inset 0 0 0 2px rgba(255,255,255,.06), var(--focus) }
    .tab--admin{ display:none }
    body[data-role="admin"] .tab--admin{ display:inline-flex }

    /* content */
    main{ max-width:1100px; margin:0 auto; padding:var(--gap); position:relative; z-index:2 }
    .card{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:16px}
    .row{display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin:18px 0}
    @media (max-width:920px){ .row{grid-template-columns:1fr} }
    .kpi{font-size:28px; font-weight:700; letter-spacing:-.02em}
    .muted{color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .grid2{display:grid; grid-template-columns:2fr 1fr; gap:14px}
    @media (max-width:920px){ .grid2{grid-template-columns:1fr} }
    canvas{width:100%; height:220px; display:block}
    table{width:100%; border-collapse:collapse; background:var(--panel); border:1px solid var(--line); border-radius:12px; overflow:hidden}
    th,td{padding:10px 12px; border-bottom:1px solid var(--line); font-size:14px}
    th{background:#0f1630; text-align:left; color:#cbd5f7}
    tr:last-child td{border-bottom:none}
    .tag{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); color:#cfe1ff}
    .ok{color:var(--good)} .warn{color:var(--warn)}
    .note{font-size:12px; color:var(--muted)}

    /* toasts */
    .toasts{position:fixed; right:16px; bottom:16px; display:grid; gap:8px; z-index:70}
    .toast{padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:rgba(0,0,0,.6); color:#fff; max-width:min(90vw,360px)}
    .toast.ok{border-color:rgba(52,211,153,.4)}
    .toast.err{border-color:rgba(239,68,68,.5)}
    .toast.warn{border-color:rgba(255,169,64,.5)}

    /* watchlist UI (Create) */
    .watchlist{display:grid; gap:10px}
    .watchlist form{display:flex; gap:8px; flex-wrap:wrap}
    .watchlist input[type=text]{flex:1; min-width:260px; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0f1630; color:var(--ink)}
    .items{display:grid; gap:8px}
    .item{display:flex; align-items:center; gap:10px; padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#0f1630}
    .item .addr{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:13px}
    .item .sp{flex:1}
  </style>
</head>
<body data-role="" data-active="">
  <canvas id="bg" aria-hidden="true"></canvas>
  <div class="vignette" aria-hidden="true"></div>

  <header>
    <div class="hdr">
      <a class="brand" href="#home" aria-label="Klerno Home">
        <img class="wordmark" src="{{ url_path_for('static', path='klerno-wordmark.png') }}" alt="Klerno Labs">
      </a>
      <div class="spacer"></div>
      <!-- header buttons removed per request -->
    </div>
  </header>

  <!-- TOP TABS -->
  <div class="tabsbar">
    <nav id="tabs" class="tabs" role="tablist" aria-label="Primary">
      <button id="tab-home"    class="tab" role="tab" aria-controls="panel-home"    aria-selected="false" tabindex="-1">Home</button>
      <button id="tab-explore" class="tab" role="tab" aria-controls="panel-explore" aria-selected="false" tabindex="-1">Explore</button>
      <button id="tab-create"  class="tab" role="tab" aria-controls="panel-create"  aria-selected="false" tabindex="-1">Create</button>
      <button id="tab-alerts"  class="tab" role="tab" aria-controls="panel-alerts"  aria-selected="false" tabindex="-1">Alerts</button>
      <button id="tab-profile" class="tab" role="tab" aria-controls="panel-profile" aria-selected="false" tabindex="-1">Profile</button>
      <button id="tab-admin"   class="tab tab--admin" role="tab" aria-controls="panel-admin" aria-selected="false" tabindex="-1">Admin</button>
    </nav>
  </div>

  <main id="main" tabindex="-1">
    <!-- HOME -->
    <section id="panel-home" role="tabpanel" aria-labelledby="tab-home" hidden>
      <div class="row">
        <div class="card"><div class="muted">Total processed</div><div class="kpi" id="kpiTotal">‚Äî</div></div>
        <div class="card"><div class="muted">Alerts ‚â• threshold</div><div class="kpi" id="kpiAlerts">‚Äî</div></div>
        <div class="card"><div class="muted">Average risk <small id="kpiAvgDelta" class="muted"></small></div><div class="kpi" id="kpiAvg">‚Äî</div></div>
      </div>

      <div class="grid2">
        <div class="card">
          <div class="muted" style="margin-bottom:8px;">
            Average risk by day
          </div>
          <canvas id="chartRisk"></canvas>
          <div class="note">Simple canvas chart from <code>/metrics-ui.series_by_day</code>.</div>
        </div>
        <div class="card">
          <div class="muted" style="margin-bottom:8px;">Top categories</div>
          <div id="cats">‚Äî</div>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="card">
        <div class="muted" style="margin-bottom:8px;">Quick actions</div>
        <div class="actions">
          <a class="btn" id="fetchXRPL">‚ö° Fetch XRPL (demo)</a>
          <a class="btn" id="analyzeSample">üß™ Analyze sample</a>
          <a class="btn" id="exportCsv">‚¨áÔ∏è Export CSV</a>
          <button class="btn primary" id="btnLoadDemo" type="button">‚ú® Load demo data</button>
        </div>
        <div class="note" style="margin-top:8px">These run using your signed-in session (no API key needed).</div>
      </div>

      <div style="height:14px"></div>

      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px; margin-bottom:8px">
          <div class="muted">Recent high-risk (live)</div>
          <label class="muted" style="font-size:12px;display:flex;align-items:center;gap:6px">
            <input id="toggleOnlyHigh" type="checkbox" checked>
            Only ‚â• threshold
          </label>
        </div>
        <table>
          <thead><tr><th>Time</th><th>From ‚Üí To</th><th>Amount</th><th>Category</th><th>Risk</th></tr></thead>
          <tbody id="tblRecent"><tr><td colspan="5" class="muted">No alerts yet</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- EXPLORE -->
    <section id="panel-explore" role="tabpanel" aria-labelledby="tab-explore" hidden>
      <div class="card" style="margin-bottom:14px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <h2 style="margin:0">Explore</h2>
        </div>
        <p class="muted" style="margin:8px 0 0">Coming soon.</p>
      </div>
    </section>

    <!-- CREATE -->
    <section id="panel-create" role="tabpanel" aria-labelledby="tab-create" hidden>
      <div class="card watchlist" style="margin-bottom:14px">
        <h2 style="margin:0">Wallet watchlist</h2>
        <form id="walletForm">
          <input id="walletInput" type="text" placeholder="Add XRPL address (e.g. rEb8TK3gBgk5‚Ä¶)" autocomplete="off">
          <button class="btn" type="submit">Add</button>
          <button class="btn ghost" id="btnStartWatch" type="button">Start live watch</button>
          <button class="btn ghost" id="btnStopWatch" type="button">Stop</button>
        </form>
        <div id="walletItems" class="items"></div>
        <div class="note">Saved to this browser only. Selected wallets will be watched in real time.</div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Actions</h3>
        <div class="note" style="margin-bottom:8px">Fetch recent transactions for any saved wallet (persists & updates live).</div>
        <div id="walletActions" class="items"></div>
      </div>
    </section>

    <!-- ALERTS -->
    <section id="panel-alerts" role="tabpanel" aria-labelledby="tab-alerts" hidden>
      <div class="card"><h2 style="margin-top:0">Alerts</h2><p class="muted">Live alerts & filters live here.</p></div>
    </section>

    <!-- PROFILE -->
    <section id="panel-profile" role="tabpanel" aria-labelledby="tab-profile" hidden>
      <div class="card">
        <h2 style="margin-top:0">Profile</h2>
        <p class="muted">Signed in as <em id="meEmail">‚Äî</em>. Role: <code id="meRole">‚Äî</code>.</p>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="panel-admin" role="tabpanel" aria-labelledby="tab-admin" hidden>
      <div class="card">
        <h2 style="margin-top:0">Admin</h2>
        <p class="muted">Admin tools. Restricted to administrators.</p>
        <div class="actions" style="margin-top:8px">
          <a class="btn" href="/docs" target="_blank" rel="noopener">üìú API Docs</a>
          <a class="btn" href="/admin/test-email?key={{ key or '' }}" target="_blank" rel="noopener">‚úâÔ∏è Send test email</a>
        </div>
      </div>
    </section>
  </main>

  <!-- Toasts -->
  <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>

  <script>
  (function(){
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    const toasts = $('#toasts');
    const body = document.body;
    const tabs = $$('#tabs [role="tab"]');
    const panels = $$('[role="tabpanel"]');

    // -------- Toasts
    function toast(msg, type='ok', ms=2400){
      const el = document.createElement('div');
      el.className = 'toast ' + type;
      el.textContent = msg;
      toasts.appendChild(el);
      setTimeout(()=>{ el.remove(); }, ms);
    }

    // -------- /me -> role controls Admin visibility
    async function loadMe(){
      try{
        const r = await fetch('/me', {credentials:'include'});
        if(!r.ok) throw 0;
        const me = await r.json();
        body.dataset.role = (me.role || 'viewer');
        $('#meEmail') && ($('#meEmail').textContent = me.email || '‚Äî');
        $('#meRole') && ($('#meRole').textContent = me.role || '‚Äî');
      }catch{ body.dataset.role=''; }
    }

    // ======== Metrics & Chart ========
    function fmt(n){ return Intl.NumberFormat().format(n); }
    function paintKPIs(m){
      $('#kpiTotal').textContent = fmt(m.total || 0);
      $('#kpiAlerts').textContent = fmt(m.alerts || 0);
      $('#kpiAvg').textContent = (m.avg_risk ?? 0).toFixed(3);

      const s = m.series_by_day || [];
      const elDelta = $('#kpiAvgDelta');
      if (s.length >= 2 && elDelta) {
        const last = +s[s.length-1].avg_risk || 0;
        const prev = +s[s.length-2].avg_risk || 0;
        const delta = (last - prev) / (prev || 1) * 100;
        elDelta.textContent = ' ‚Ä¢ ' + (delta>=0? '‚ñ≤':'‚ñº') + Math.abs(delta).toFixed(1) + '%';
      } else if (elDelta) elDelta.textContent = '';

      const catsDiv = $('#cats');
      if (catsDiv){
        const cats = Object.entries(m.categories || {}).sort((a,b)=>b[1]-a[1]).slice(0,6);
        catsDiv.innerHTML = cats.length ? cats.map(([k,v])=>`<span class="tag">${k} ¬∑ ${v}</span>`).join(' ') : '<span class="muted">none</span>';
      }
    }

    function paintChart(series){
      const cv = $('#chartRisk'); if(!cv) return;
      const dpr = Math.min(window.devicePixelRatio||1,2);
      const parent = cv.parentElement;
      const w = parent.clientWidth, h = 220;
      cv.width = Math.floor(w*dpr); cv.height = Math.floor(h*dpr);
      cv.style.width = w+'px'; cv.style.height = h+'px';
      const ctx = cv.getContext('2d'); ctx.scale(dpr,dpr);
      if(!series.length){ ctx.fillStyle='rgba(255,255,255,.45)'; ctx.fillText('No data yet', 16, 24); return; }
      const xs = series.map(d => new Date(d.date).getTime());
      const ys = series.map(d => +d.avg_risk || 0);
      const minX=Math.min(...xs), maxX=Math.max(...xs);
      const minY=Math.min(0, ...ys), maxY=Math.max(1, ...ys);
      const pad=16, top=10, bottom=28;
      const iw = w - pad*2, ih = h - top - bottom;
      const X = t => pad + ((t-minX)/(maxX-minX || 1))*iw;
      const Y = v => top + ih - ((v-minY)/(maxY-minY || 1))*ih;
      const grad = ctx.createLinearGradient(0, top, 0, top+ih);
      grad.addColorStop(0,'rgba(123,108,255,.45)'); grad.addColorStop(1,'rgba(123,108,255,0)');
      ctx.beginPath(); ctx.moveTo(X(xs[0]), Y(ys[0]));
      for(let i=1;i<xs.length;i++) ctx.lineTo(X(xs[i]), Y(ys[i]));
      ctx.lineTo(X(xs[xs.length-1]), top+ih); ctx.lineTo(X(xs[0]), top+ih); ctx.closePath();
      ctx.fillStyle = grad; ctx.fill();
      ctx.beginPath(); ctx.moveTo(X(xs[0]), Y(ys[0]));
      for(let i=1;i<xs.length;i++) ctx.lineTo(X(xs[i]), Y(ys[i]));
      ctx.strokeStyle='rgba(160,200,255,.9)'; ctx.lineWidth=2; ctx.stroke();
    }

    async function loadMetricsOnce(){
      try{
        // ask for 365 days so older sample data shows on the chart
        const r = await fetch(`/metrics-ui?days=365`, { credentials:'include' });
        if(!r.ok) throw 0;
        const data = await r.json();
        paintKPIs(data);
        paintChart(data.series_by_day || []);
      }catch{ /* leave skeletons */ }
    }

    // ======== Live feed (WebSocket) ========
    const tbl = $('#tblRecent');
    const onlyHighEl = $('#toggleOnlyHigh');
    let ws = null;
    let recentRows = []; // keep latest rows we rendered

    function riskOf(it){ return Number(it.risk_score ?? it.score ?? 0); }

    function renderRecent(){
      if(!tbl) return;
      if(!recentRows.length){
        tbl.innerHTML = `<tr><td colspan="5" class="muted">No alerts yet</td></tr>`;
        return;
      }
      tbl.innerHTML = recentRows.map(it=>{
        const t  = (it.timestamp||'').toString().replace('T',' ').slice(0,19);
        const ft = `${(it.from_addr||'').slice(0,6)}‚Ä¶ ‚Üí ${(it.to_addr||'').slice(0,6)}‚Ä¶`;
        const amt= `${(+it.amount||0).toFixed(2)} ${(it.symbol||'')}`;
        const cat= it.category || 'unknown';
        const risk= riskOf(it);
        const cls = risk >= 0.75 ? 'warn' : 'ok';
        return `<tr><td>${t}</td><td>${ft}</td><td>${amt}</td><td><span class="tag">${cat}</span></td><td class="${cls}">${risk.toFixed(3)}</td></tr>`;
      }).join('');
    }

    function pushIncoming(it){
      const onlyHigh = !!onlyHighEl?.checked;
      if(onlyHigh && riskOf(it) < 0.75) return;
      // first row clears placeholder
      if(!recentRows.length && tbl) tbl.innerHTML = '';
      recentRows.unshift(it);
      if(recentRows.length > 50) recentRows.length = 50;
      renderRecent();
    }

    function connectWS(){
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const url = `${proto}://${location.host}/ws/alerts`;
      try{
        ws = new WebSocket(url);
      }catch(e){
        toast('WebSocket failed to initialize', 'err'); return;
      }
      ws.addEventListener('open', ()=>{ sendWatch(); });
      ws.addEventListener('message', (ev)=>{
        try{
          const msg = JSON.parse(ev.data||'{}');
          if(msg.type === 'tx' && msg.item){ pushIncoming(msg.item); }
        }catch{}
      });
      ws.addEventListener('close', ()=>{ setTimeout(connectWS, 1500); });
      ws.addEventListener('error', ()=>{ try{ ws.close(); }catch{} });
    }

    // ======== Watchlist (Create tab) ========
    const LS_KEY = 'klerno.watchlist.v1';
    function getWatchlist(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return []; } }
    function setWatchlist(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); renderWatchlist(); renderWalletActions(); sendWatch(); }

    function renderWatchlist(){
      const items = getWatchlist();
      const wrap = $('#walletItems'); if(!wrap) return;
      if(!items.length){ wrap.innerHTML = `<div class="note">No wallets saved yet.</div>`; return; }
      wrap.innerHTML = items.map((o,i)=>`
        <div class="item">
          <input type="checkbox" data-idx="${i}" ${o.watch? 'checked':''} title="Watch live">
          <span class="addr">${o.addr}</span>
          <span class="sp"></span>
          <button class="btn ghost" data-act="fetch" data-idx="${i}" title="Fetch recent">Fetch</button>
          <button class="btn ghost" data-act="remove" data-idx="${i}" title="Remove">‚úï</button>
        </div>
      `).join('');
    }

    function renderWalletActions(){
      const items = getWatchlist();
      const wrap = $('#walletActions'); if(!wrap) return;
      if(!items.length){ wrap.innerHTML = `<div class="note">Add wallets above to enable actions.</div>`; return; }
      wrap.innerHTML = items.map((o,i)=>`
        <div class="item">
          <span class="addr">${o.addr}</span>
          <span class="sp"></span>
          <button class="btn" data-act="fetch" data-idx="${i}">Fetch recent</button>
        </div>
      `).join('');
    }

    function sendWatch(){
      const items = getWatchlist();
      const watching = items.filter(o=>o.watch).map(o=>o.addr);
      if(ws && ws.readyState === 1){
        ws.send(JSON.stringify({watch: watching}));
      }
    }

    // Add wallet
    $('#walletForm')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const inp = $('#walletInput');
      const v = (inp.value||'').trim();
      if(!v){ inp.focus(); return; }
      const items = getWatchlist();
      if(items.some(o=>o.addr.toLowerCase()===v.toLowerCase())){ toast('Already saved', 'warn'); return; }
      items.push({addr:v, watch:true});
      setWatchlist(items);
      inp.value='';
      toast('Wallet saved & watching ‚úì');
    });

    // Toggle watch / remove / fetch
    $('#panel-create')?.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button');
      const ck  = e.target.closest('input[type=checkbox]');
      if(ck && ck.dataset.idx){
        const items = getWatchlist();
        const i = +ck.dataset.idx;
        if(items[i]){ items[i].watch = ck.checked; setWatchlist(items); toast(ck.checked?'Watching':'Stopped', 'ok'); }
        return;
      }
      if(!btn) return;
      const idx = +btn.dataset.idx;
      const act = btn.dataset.act;
      const items = getWatchlist();
      const it = items[idx];
      if(act==='remove'){
        items.splice(idx,1); setWatchlist(items); toast('Removed');
      }else if(act==='fetch' && it){
        await fetchRecent(it.addr);
      }
    });

    $('#btnStartWatch')?.addEventListener('click', ()=>{ sendWatch(); toast('Live watch started'); });
    $('#btnStopWatch')?.addEventListener('click', ()=>{ if(ws) try{ ws.close(); }catch{}; toast('Live watch stopped','warn'); });

    async function fetchRecent(addr){
      const url = `/uiapi/integrations/xrpl/fetch_and_save?account=${encodeURIComponent(addr)}&limit=10`;
      try{
        const r = await fetch(url, { method:'POST', credentials:'include' });
        if(!r.ok){
          const t = await r.text().catch(()=> '');
          toast(`Fetch failed (${r.status}) ${t.slice(0,100)}`, 'err', 5000);
        }else{
          toast('Fetched & saved ‚úì');
          await loadMetricsOnce();
        }
      }catch(e){ toast(`Fetch error: ${e?.message||e}`, 'err', 5000); }
    }

    // ======== ‚ÄúQuick actions‚Äù (Home) ========
    $('#fetchXRPL')?.addEventListener('click', async ()=>{
      const acct = prompt('XRPL account to fetch (e.g. rEb8TK3gBgk5...)','rEb8TK3gBgk5auZkwc6sHnwrGVJH8DuaLh');
      if (!acct) return;
      await fetchRecent(acct);
    });

    $('#analyzeSample')?.addEventListener('click', async ()=>{
      const r = await fetch('/uiapi/analyze/sample', { method:'POST', credentials:'include' });
      toast(r.ok ? 'Sample analyzed ‚úì' : 'Analyze failed', r.ok ? 'ok' : 'err');
      await loadMetricsOnce();
    });

    $('#exportCsv')?.addEventListener('click', ()=>{ window.open('/uiapi/export/csv/download', '_blank'); });

    $('#btnLoadDemo')?.addEventListener('click', async ()=>{
      try{
        const r = await fetch('/uiapi/analyze/sample', { method:'POST', credentials:'include' });
        if(!r.ok){
          const t = await r.text().catch(()=> '');
          toast(`Could not load demo data (${r.status}) ${t.slice(0,120)}`, 'err', 5000);
        } else {
          toast('Demo data loaded ‚úì');
          await loadMetricsOnce();
        }
      }catch(e){ toast(`Demo load error: ${e?.message||e}`, 'err', 5000); }
    });

    // ======== Tabs + router
    function setSelected(tab){
      const target = tab.getAttribute('aria-controls');
      tabs.forEach(t=>{ const sel = (t===tab); t.setAttribute('aria-selected', sel); t.tabIndex = sel ? 0 : -1; });
      panels.forEach(p => p.hidden = (p.id !== target));
      tab.focus({preventScroll:true});
      const hash = '#' + (tab.id.replace(/^tab-/, ''));
      if (location.hash !== hash) history.replaceState(null, '', hash);
      document.title = 'Klerno ‚Ä¢ ' + tab.textContent;
      body.dataset.active = hash.slice(1);
      if (hash === '#admin' && body.dataset.role !== 'admin') {
        toast('Admins only', 'warn');
        history.replaceState(null, '', '#home');
        selectTabById('tab-home');
      }
    }
    function selectTabById(id){ const tab = $('#'+id); if (tab) setSelected(tab); }
    $('#tabs').addEventListener('click', (e)=>{ const btn = e.target.closest('[role="tab"]'); if(btn) setSelected(btn); });
    function routeFromHash(){
      const valid = new Set(['home','explore','create','alerts','profile','admin']);
      const raw = (location.hash || '#home').replace('#','').toLowerCase().trim();
      const name = valid.has(raw) ? raw : 'home';
      if (name==='admin' && body.dataset.role !== 'admin'){ toast('Admins only', 'warn'); history.replaceState(null, '', '#home'); selectTabById('tab-home'); return; }
      selectTabById('tab-' + name);
    }
    window.addEventListener('hashchange', routeFromHash);

    // ======== Boot
    (async function boot(){
      await loadMe();
      renderWatchlist(); renderWalletActions();
      connectWS();
      await loadMetricsOnce();
      routeFromHash();
      // Faster auto refresh (3 seconds) ‚Äî metrics only; live rows come via WS
      setInterval(()=>{ if(!document.hidden) loadMetricsOnce(); }, 3000);
    })();

    // Background animation (unchanged)
    (function(){
      const bg = document.getElementById('bg'); if(!bg) return;
      const ctx = bg.getContext('2d');
      let W,H,DPR=Math.min(window.devicePixelRatio||1,2), P=[];
      function rnd(n){ return Math.random(); }
      function resize(){
        W=bg.width = Math.floor(innerWidth*DPR);
        H=bg.height= Math.floor(innerHeight*DPR);
        bg.style.width = innerWidth+'px'; bg.style.height= innerHeight+'px';
        const n=Math.floor((W*H)/(90_000*DPR));
        P = Array.from({length:n},()=>({ x:rnd()*W, y:rnd()*H, vx:(rnd()-.5)*.35*DPR, vy:(rnd()-.5)*.35*DPR }));
      }
      function step(){
        ctx.clearRect(0,0,W,H);
        const g=ctx.createLinearGradient(0,0,W,H);
        g.addColorStop(0,'rgba(123,108,255,.10)'); g.addColorStop(.5,'rgba(0,225,255,.08)'); g.addColorStop(1,'rgba(255,255,255,.05)');
        ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
        ctx.fillStyle='rgba(255,255,255,.45)';
        for(const p of P){
          p.x+=p.vx; p.y+=p.vy;
          if(p.x<0||p.x>W) p.vx*=-1;
          if(p.y<0||p.y>H) p.vy*=-1;
          ctx.beginPath(); ctx.arc(p.x,p.y,1.3*DPR,0,Math.PI*2); ctx.fill();
        }
        ctx.strokeStyle='rgba(200,220,255,.11)';
        for(let i=0;i<P.length;i++){
          const a=P[i];
          for(let j=i+1;j<P.length;j++){
            const b=P[j],dx=a.x-b.x,dy=a.y-b.y,d2=dx*dx+dy*dy;
            if(d2<18000*DPR){
              ctx.globalAlpha=1-d2/(18000*DPR);
              ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
            }
          }
        }
        ctx.globalAlpha=1; requestAnimationFrame(step);
      }
      resize(); requestAnimationFrame(step); addEventListener('resize', resize);
    })();
  })();
  </script>
</body>
</html>
