{% extends "base.html" %}

{% block title %}Analytics Dashboard - Klerno Labs{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
    .analytics-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .dashboard-header {
        text-align: center;
        color: white;
        margin-bottom: 2rem;
    }

    .dashboard-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .dashboard-header p {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .metric-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .metric-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .metric-title {
        font-size: 0.9rem;
        color: #666;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-icon {
        width: 24px;
        height: 24px;
        opacity: 0.7;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .metric-change {
        font-size: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .metric-change.positive {
        color: #10b981;
    }

    .metric-change.negative {
        color: #ef4444;
    }

    .metric-change.neutral {
        color: #6b7280;
    }

    .charts-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .chart-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .analytics-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .tab-button {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .tab-button.active {
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .real-time-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        color: #10b981;
        margin-bottom: 1rem;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .data-table th,
    .data-table td {
        text-align: left;
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .data-table th {
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
    }

    .alert-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: #fef3cd;
        border: 1px solid #fde68a;
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }

    .alert-icon {
        width: 20px;
        height: 20px;
        color: #d97706;
    }

    .alert-high {
        background: #fecaca;
        border-color: #fca5a5;
        color: #dc2626;
    }

    .alert-medium {
        background: #fed7aa;
        border-color: #fdba74;
        color: #ea580c;
    }

    .alert-low {
        background: #d1fae5;
        border-color: #a7f3d0;
        color: #059669;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .connection-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        z-index: 1000;
        transition: all 0.3s ease;
    }

    .connection-status.connected {
        background: rgba(16, 185, 129, 0.9);
        color: white;
    }

    .connection-status.disconnected {
        background: rgba(239, 68, 68, 0.9);
        color: white;
    }

    @media (max-width: 768px) {
        .charts-section {
            grid-template-columns: 1fr;
        }

        .metrics-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .dashboard-header h1 {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-dashboard">
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1>Analytics Dashboard</h1>
            <p>Real-time monitoring and insights for Klerno Labs</p>
            <div class="real-time-indicator">
                <div class="status-dot"></div>
                Live Data
            </div>
        </div>

        <!-- Connection Status -->
        <div id="connection-status" class="connection-status disconnected">
            Connecting...
        </div>

        <!-- Navigation Tabs -->
        <div class="analytics-tabs">
            <button class="tab-button active" onclick="switchTab('overview')">Overview</button>
            <button class="tab-button" onclick="switchTab('performance')">Performance</button>
            <button class="tab-button" onclick="switchTab('users')">Users</button>
            <button class="tab-button" onclick="switchTab('security')">Security</button>
            <button class="tab-button" onclick="switchTab('alerts')">Alerts</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <!-- Key Metrics Grid -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Response Time</div>
                        <svg class="metric-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="response-time">--</div>
                    <div class="metric-change" id="response-time-change">
                        <span>Loading...</span>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Active Users</div>
                        <svg class="metric-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5 0a4 4 0 11-8 0 4 4 0 018 0z">
                            </path>
                        </svg>
                    </div>
                    <div class="metric-value" id="active-users">--</div>
                    <div class="metric-change" id="active-users-change">
                        <span>Loading...</span>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Requests/Min</div>
                        <svg class="metric-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                    </div>
                    <div class="metric-value" id="requests-per-min">--</div>
                    <div class="metric-change" id="requests-change">
                        <span>Loading...</span>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Error Rate</div>
                        <svg class="metric-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z">
                            </path>
                        </svg>
                    </div>
                    <div class="metric-value" id="error-rate">--</div>
                    <div class="metric-change" id="error-rate-change">
                        <span>Loading...</span>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">CPU Usage</div>
                        <svg class="metric-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z">
                            </path>
                        </svg>
                    </div>
                    <div class="metric-value" id="cpu-usage">--</div>
                    <div class="metric-change" id="cpu-change">
                        <span>Loading...</span>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Memory Usage</div>
                        <svg class="metric-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4">
                            </path>
                        </svg>
                    </div>
                    <div class="metric-value" id="memory-usage">--</div>
                    <div class="metric-change" id="memory-change">
                        <span>Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-container">
                    <div class="chart-title">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                        Performance Trends (24h)
                    </div>
                    <canvas id="performance-chart" width="400" height="200"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                            </path>
                        </svg>
                        User Activity
                    </div>
                    <canvas id="user-activity-chart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Performance Tab -->
        <div id="performance-tab" class="tab-content">
            <div class="chart-container">
                <div class="chart-title">Detailed Performance Metrics</div>
                <canvas id="detailed-performance-chart" width="400" height="300"></canvas>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content">
            <div class="charts-section">
                <div class="chart-container">
                    <div class="chart-title">User Demographics</div>
                    <canvas id="user-demographics-chart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Traffic Sources</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>Percentage</th>
                                <th>Sessions</th>
                            </tr>
                        </thead>
                        <tbody id="traffic-sources-table">
                            <tr>
                                <td colspan="3">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Security Tab -->
        <div id="security-tab" class="tab-content">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Blocked Requests</div>
                        <svg class="metric-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636">
                            </path>
                        </svg>
                    </div>
                    <div class="metric-value" id="blocked-requests">--</div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Threat Level</div>
                        <svg class="metric-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                            </path>
                        </svg>
                    </div>
                    <div class="metric-value" id="threat-level">--</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Security Events</div>
                <div id="security-events-list">
                    <div class="loading-spinner"></div> Loading security events...
                </div>
            </div>
        </div>

        <!-- Alerts Tab -->
        <div id="alerts-tab" class="tab-content">
            <div class="chart-container">
                <div class="chart-title">System Alerts</div>
                <div id="alerts-list">
                    <div class="loading-spinner"></div> Loading alerts...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Global variables for charts
    let performanceChart = null;
    let userActivityChart = null;
    let detailedPerformanceChart = null;
    let userDemographicsChart = null;
    let websocket = null;
    let isConnected = false;

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
        initializeCharts();
        connectWebSocket();
        loadInitialData();
    });

    // WebSocket connection
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/analytics/ws`;

        websocket = new WebSocket(wsUrl);

        websocket.onopen = function (event) {
            console.log('WebSocket connected');
            isConnected = true;
            updateConnectionStatus('connected');
        };

        websocket.onmessage = function (event) {
            const data = JSON.parse(event.data);
            if (data.type === 'metrics_update' || data.timestamp) {
                updateDashboard(data.data || data);
            }
        };

        websocket.onclose = function (event) {
            console.log('WebSocket disconnected');
            isConnected = false;
            updateConnectionStatus('disconnected');

            // Attempt to reconnect after 5 seconds
            setTimeout(connectWebSocket, 5000);
        };

        websocket.onerror = function (error) {
            console.error('WebSocket error:', error);
            isConnected = false;
            updateConnectionStatus('disconnected');
        };
    }

    // Update connection status indicator
    function updateConnectionStatus(status) {
        const statusElement = document.getElementById('connection-status');
        statusElement.className = `connection-status ${status}`;
        statusElement.textContent = status === 'connected' ? 'Connected' : 'Disconnected';
    }

    // Tab switching
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });
        event.target.classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');

        // Load tab-specific data
        if (tabName === 'users') {
            loadUserAnalytics();
        } else if (tabName === 'security') {
            loadSecurityAnalytics();
        } else if (tabName === 'alerts') {
            loadAlerts();
        } else if (tabName === 'performance') {
            loadPerformanceHistory();
        }
    }

    // Initialize charts
    function initializeCharts() {
        // Performance chart
        const performanceCtx = document.getElementById('performance-chart').getContext('2d');
        performanceChart = new Chart(performanceCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Response Time (ms)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1
                }, {
                    label: 'CPU Usage (%)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Response Time (ms)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'CPU Usage (%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            }
        });

        // User activity chart
        const userActivityCtx = document.getElementById('user-activity-chart').getContext('2d');
        userActivityChart = new Chart(userActivityCtx, {
            type: 'doughnut',
            data: {
                labels: ['New Users', 'Returning Users', 'Power Users'],
                datasets: [{
                    data: [30, 60, 10],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Detailed performance chart
        const detailedPerformanceCtx = document.getElementById('detailed-performance-chart').getContext('2d');
        detailedPerformanceChart = new Chart(detailedPerformanceCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour'
                        }
                    }
                }
            }
        });

        // User demographics chart
        const userDemographicsCtx = document.getElementById('user-demographics-chart').getContext('2d');
        userDemographicsChart = new Chart(userDemographicsCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Load initial data
    async function loadInitialData() {
        try {
            const response = await fetch('/analytics/api/metrics');
            const data = await response.json();
            updateDashboard(data);
        } catch (error) {
            console.error('Error loading initial data:', error);
        }
    }

    // Update dashboard with new data
    function updateDashboard(data) {
        if (!data || data.error) {
            console.error('Invalid data received:', data);
            return;
        }

        // Update key metrics
        if (data.performance) {
            updateMetric('response-time',
                (data.performance.request_performance.avg_response_time * 1000).toFixed(0) + 'ms',
                data.performance.trends?.response_time || 'stable'
            );

            updateMetric('cpu-usage',
                data.performance.system_performance.cpu_percent.toFixed(1) + '%',
                data.performance.trends?.cpu_trend || 'stable'
            );

            updateMetric('memory-usage',
                data.performance.system_performance.memory_percent.toFixed(1) + '%',
                data.performance.trends?.memory_trend || 'stable'
            );

            updateMetric('error-rate',
                ((data.performance.error_rates.length / data.performance.request_performance.total_requests) * 100).toFixed(2) + '%',
                data.performance.trends?.error_rate || 'stable'
            );
        }

        if (data.real_time_stats) {
            updateMetric('active-users',
                data.real_time_stats.unique_visitors_today.toString(),
                'stable'
            );

            updateMetric('requests-per-min',
                data.real_time_stats.requests_last_minute.toString(),
                'stable'
            );
        }

        // Update charts with new data
        updateCharts(data);
    }

    // Update individual metric
    function updateMetric(metricId, value, trend) {
        const valueElement = document.getElementById(metricId);
        const changeElement = document.getElementById(metricId + '-change');

        if (valueElement) {
            valueElement.textContent = value;
        }

        if (changeElement) {
            const trendText = trend === 'up' ? '↗ Increasing' :
                trend === 'down' ? '↘ Decreasing' :
                    '→ Stable';

            changeElement.innerHTML = `<span>${trendText}</span>`;
            changeElement.className = `metric-change ${trend === 'up' ? 'positive' : trend === 'down' ? 'negative' : 'neutral'}`;
        }
    }

    // Update charts
    function updateCharts(data) {
        // Update performance chart with recent data
        if (performanceChart && data.performance) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();

            // Add new data point
            performanceChart.data.labels.push(timeLabel);
            performanceChart.data.datasets[0].data.push(data.performance.request_performance.avg_response_time * 1000);
            performanceChart.data.datasets[1].data.push(data.performance.system_performance.cpu_percent);

            // Keep only last 20 data points
            if (performanceChart.data.labels.length > 20) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets[0].data.shift();
                performanceChart.data.datasets[1].data.shift();
            }

            performanceChart.update('none');
        }

        // Update user activity chart
        if (userActivityChart && data.analytics) {
            // This would be updated with real user segment data
            userActivityChart.update();
        }
    }

    // Load user analytics
    async function loadUserAnalytics() {
        try {
            const response = await fetch('/analytics/api/user-analytics');
            const data = await response.json();

            // Update user demographics chart
            if (userDemographicsChart && data.device_analytics) {
                const devices = data.device_analytics.devices;
                userDemographicsChart.data.labels = Object.keys(devices);
                userDemographicsChart.data.datasets = [{
                    label: 'Device Usage',
                    data: Object.values(devices),
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(255, 206, 86, 0.8)'
                    ]
                }];
                userDemographicsChart.update();
            }

            // Update traffic sources table
            if (data.traffic_sources) {
                const tableBody = document.getElementById('traffic-sources-table');
                tableBody.innerHTML = '';

                Object.entries(data.traffic_sources).forEach(([source, percentage]) => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                    <td>${source.replace('_', ' ').toUpperCase()}</td>
                    <td>${percentage.toFixed(1)}%</td>
                    <td>${Math.round(percentage * 10)}</td>
                `;
                });
            }

        } catch (error) {
            console.error('Error loading user analytics:', error);
        }
    }

    // Load security analytics
    async function loadSecurityAnalytics() {
        try {
            const response = await fetch('/analytics/api/security-analytics');
            const data = await response.json();

            // Update security metrics
            document.getElementById('blocked-requests').textContent = data.threat_summary.blocked_requests;
            document.getElementById('threat-level').textContent = 'Medium';

            // Update security events list
            const eventsList = document.getElementById('security-events-list');
            eventsList.innerHTML = '';

            data.security_events.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = `alert-item alert-${event.severity}`;
                eventElement.innerHTML = `
                <svg class="alert-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <div>
                    <strong>${event.type}</strong><br>
                    IP: ${event.ip} • ${new Date(event.timestamp * 1000).toLocaleString()}
                </div>
            `;
                eventsList.appendChild(eventElement);
            });

        } catch (error) {
            console.error('Error loading security analytics:', error);
        }
    }

    // Load alerts
    async function loadAlerts() {
        const alertsList = document.getElementById('alerts-list');
        alertsList.innerHTML = '<div class="alert-item alert-low">✓ All systems operational</div>';
    }

    // Load performance history
    async function loadPerformanceHistory() {
        try {
            const response = await fetch('/analytics/api/performance-history?hours=24');
            const data = await response.json();

            if (detailedPerformanceChart && data.data_points) {
                const labels = data.data_points.map(point => new Date(point.timestamp * 1000));

                detailedPerformanceChart.data.labels = labels;
                detailedPerformanceChart.data.datasets = [
                    {
                        label: 'Response Time (ms)',
                        data: data.data_points.map(point => point.response_time * 1000),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1
                    },
                    {
                        label: 'CPU Usage (%)',
                        data: data.data_points.map(point => point.cpu_percent),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1
                    },
                    {
                        label: 'Memory Usage (%)',
                        data: data.data_points.map(point => point.memory_percent),
                        borderColor: 'rgb(255, 206, 86)',
                        backgroundColor: 'rgba(255, 206, 86, 0.1)',
                        tension: 0.1
                    }
                ];

                detailedPerformanceChart.update();
            }

        } catch (error) {
            console.error('Error loading performance history:', error);
        }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function () {
        if (websocket) {
            websocket.close();
        }
    });
</script>
{% endblock %}