{% extends "base.html" %}

{% block title %}Unlock Professional Access - Klerno Labs{% endblock %}

{% block content %}
<style>
/* Professional Paywall Styles - Top 0.1% Design */
.paywall-container {
  min-height: 100vh;
  background: linear-gradient(135deg, 
    var(--color-primary-100) 0%, 
    var(--color-primary-50) 50%, 
    var(--color-background-primary) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-8) var(--space-4);
  position: relative;
  overflow: hidden;
}

.paywall-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 25% 25%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 75% 75%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
  pointer-events: none;
}

.paywall-card {
  background: var(--glass-bg);
  backdrop-filter: var(--glass-blur);
  border: var(--glass-border);
  border-radius: var(--radius-3xl);
  padding: var(--space-12);
  max-width: 1200px;
  width: 100%;
  box-shadow: var(--shadow-2xl);
  position: relative;
  z-index: 1;
}

.paywall-header {
  text-align: center;
  margin-bottom: var(--space-12);
}

.paywall-title {
  font-size: var(--text-5xl);
  font-weight: var(--font-black);
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: var(--space-4);
  line-height: 1.1;
}

.paywall-subtitle {
  font-size: var(--text-xl);
  color: var(--color-text-secondary);
  font-weight: var(--font-medium);
  max-width: 600px;
  margin: 0 auto;
}

.pricing-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: var(--space-8);
  margin-bottom: var(--space-12);
}

.pricing-card {
  background: var(--glass-bg);
  border: var(--glass-border);
  border-radius: var(--radius-2xl);
  padding: var(--space-8);
  position: relative;
  transition: all var(--transition-smooth);
  cursor: pointer;
  transform: scale(1);
}

.pricing-card:hover {
  transform: scale(1.02) translateY(-4px);
  box-shadow: var(--shadow-xl);
  border-color: var(--color-primary-400);
}

.pricing-card.popular {
  border: 2px solid var(--color-primary-500);
  position: relative;
}

.pricing-card.popular::before {
  content: 'Most Popular';
  position: absolute;
  top: -12px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--gradient-primary);
  color: white;
  padding: var(--space-2) var(--space-4);
  border-radius: var(--radius-full);
  font-size: var(--text-sm);
  font-weight: var(--font-semibold);
  box-shadow: var(--shadow-lg);
}

.pricing-card.selected {
  border-color: var(--color-primary-500);
  background: linear-gradient(135deg, 
    var(--color-primary-50), 
    var(--glass-bg));
}

.pricing-tier {
  font-size: var(--text-2xl);
  font-weight: var(--font-bold);
  color: var(--color-text-primary);
  margin-bottom: var(--space-2);
}

.pricing-amount {
  font-size: var(--text-4xl);
  font-weight: var(--font-black);
  color: var(--color-primary-600);
  margin-bottom: var(--space-1);
}

.pricing-currency {
  font-size: var(--text-lg);
  color: var(--color-text-secondary);
  margin-bottom: var(--space-6);
}

.pricing-features {
  list-style: none;
  padding: 0;
  margin: 0 0 var(--space-8);
}

.pricing-features li {
  display: flex;
  align-items: center;
  margin-bottom: var(--space-3);
  color: var(--color-text-secondary);
  font-size: var(--text-base);
}

.pricing-features li::before {
  content: '✓';
  color: var(--color-success-500);
  font-weight: var(--font-bold);
  margin-right: var(--space-3);
  font-size: var(--text-lg);
}

.pricing-button {
  width: 100%;
  padding: var(--space-4) var(--space-6);
  border-radius: var(--radius-xl);
  border: none;
  font-size: var(--text-lg);
  font-weight: var(--font-semibold);
  transition: all var(--transition-smooth);
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.pricing-button.primary {
  background: var(--gradient-primary);
  color: white;
  box-shadow: var(--shadow-lg);
}

.pricing-button.primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-xl);
}

.pricing-button.secondary {
  background: var(--color-background-secondary);
  color: var(--color-text-primary);
  border: 2px solid var(--color-border-primary);
}

.pricing-button.secondary:hover {
  background: var(--color-background-tertiary);
  border-color: var(--color-primary-400);
}

.payment-flow {
  margin-top: var(--space-12);
  padding-top: var(--space-12);
  border-top: 1px solid var(--color-border-primary);
}

.payment-step {
  display: none;
  animation: fadeInUp 0.5s ease-out;
}

.payment-step.active {
  display: block;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.payment-details {
  background: var(--color-background-secondary);
  border: 1px solid var(--color-border-primary);
  border-radius: var(--radius-xl);
  padding: var(--space-6);
  margin: var(--space-6) 0;
}

.payment-field {
  margin-bottom: var(--space-4);
}

.payment-field label {
  display: block;
  font-weight: var(--font-semibold);
  color: var(--color-text-primary);
  margin-bottom: var(--space-2);
}

.payment-field input {
  width: 100%;
  padding: var(--space-4);
  border: 2px solid var(--color-border-primary);
  border-radius: var(--radius-lg);
  background: var(--color-background-primary);
  color: var(--color-text-primary);
  font-size: var(--text-base);
  transition: all var(--transition-base);
}

.payment-field input:focus {
  outline: none;
  border-color: var(--color-primary-500);
  box-shadow: 0 0 0 3px var(--color-primary-100);
}

.status-message {
  border-radius: var(--radius-xl);
  padding: var(--space-6);
  margin: var(--space-6) 0;
  display: flex;
  align-items: center;
  gap: var(--space-3);
  font-weight: var(--font-medium);
}

.status-success {
  background: var(--color-success-50);
  border: 1px solid var(--color-success-200);
  color: var(--color-success-700);
}

.status-error {
  background: var(--color-error-50);
  border: 1px solid var(--color-error-200);
  color: var(--color-error-700);
}

.status-loading {
  background: var(--color-primary-50);
  border: 1px solid var(--color-primary-200);
  color: var(--color-primary-700);
}

.button-group {
  display: flex;
  gap: var(--space-4);
  margin-top: var(--space-6);
  flex-wrap: wrap;
}

.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: var(--space-6);
  margin: var(--space-12) 0;
}

.feature-card {
  text-align: center;
  padding: var(--space-6);
}

.feature-icon {
  font-size: var(--text-4xl);
  margin-bottom: var(--space-4);
}

.feature-title {
  font-size: var(--text-xl);
  font-weight: var(--font-bold);
  color: var(--color-text-primary);
  margin-bottom: var(--space-2);
}

.feature-description {
  color: var(--color-text-secondary);
  line-height: 1.6;
}

@media (max-width: 768px) {
  .paywall-card {
    padding: var(--space-8);
    margin: var(--space-4);
  }
  
  .paywall-title {
    font-size: var(--text-3xl);
  }
  
  .pricing-grid {
    grid-template-columns: 1fr;
    gap: var(--space-6);
  }
  
  .button-group {
    flex-direction: column;
  }
}
</style>

<div class="paywall-container">
  <div class="paywall-card">
    <!-- Header -->
    <div class="paywall-header">
      <h1 class="paywall-title">Unlock Professional Access</h1>
      <p class="paywall-subtitle">
        Join thousands of professionals using Klerno Labs for advanced blockchain compliance and risk analysis
      </p>
    </div>

    <!-- Features Grid -->
    <div class="features-grid">
      <div class="feature-card">
        <div class="feature-icon">🚀</div>
        <h3 class="feature-title">Real-time Analysis</h3>
        <p class="feature-description">Monitor transactions and get instant risk scores with our advanced AI engine</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">📊</div>
        <h3 class="feature-title">Compliance Reports</h3>
        <p class="feature-description">Generate comprehensive compliance reports for regulatory requirements</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">🔒</div>
        <h3 class="feature-title">Enterprise Security</h3>
        <p class="feature-description">Bank-grade security with encrypted data and secure API access</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">⚡</div>
        <h3 class="feature-title">Lightning Fast</h3>
        <p class="feature-description">Sub-second response times with our optimized infrastructure</p>
      </div>
    </div>

    <!-- Pricing Tiers -->
    <div class="pricing-grid" id="pricing-tiers">
      <div class="pricing-card" data-tier="1" data-amount="10">
        <h3 class="pricing-tier">Starter</h3>
        <div class="pricing-amount">10</div>
        <div class="pricing-currency">XRP / month</div>
        <ul class="pricing-features">
          <li>Up to 1,000 transactions</li>
          <li>Starter risk analysis</li>
          <li>Email alerts</li>
          <li>Standard support</li>
          <li>API rate limit: 100/hour</li>
        </ul>
        <button class="pricing-button secondary" onclick="selectTier(1, 10)">
          Get Started
        </button>
      </div>

      <div class="pricing-card popular" data-tier="2" data-amount="25">
        <h3 class="pricing-tier">Professional</h3>
        <div class="pricing-amount">25</div>
        <div class="pricing-currency">XRP / month</div>
        <ul class="pricing-features">
          <li>Unlimited transactions</li>
          <li>Advanced AI analysis</li>
          <li>Real-time monitoring</li>
          <li>Priority support</li>
          <li>API rate limit: 1,000/hour</li>
          <li>Custom integrations</li>
        </ul>
        <button class="pricing-button primary" onclick="selectTier(2, 25)">
          Most Popular
        </button>
      </div>

      <div class="pricing-card" data-tier="3" data-amount="50">
        <h3 class="pricing-tier">Enterprise</h3>
        <div class="pricing-amount">50</div>
        <div class="pricing-currency">XRP / month</div>
        <ul class="pricing-features">
          <li>Everything in Professional</li>
          <li>Dedicated account manager</li>
          <li>Custom compliance rules</li>
          <li>White-label options</li>
          <li>Unlimited API access</li>
          <li>On-premise deployment</li>
        </ul>
        <button class="pricing-button secondary" onclick="selectTier(3, 50)">
          Contact Sales
        </button>
      </div>
    </div>

    <!-- Payment Flow -->
    <div class="payment-flow" id="payment-flow" style="display: none;">
      <!-- Step 1: Create Payment -->
      <div class="payment-step active" id="step-1">
        <h3>Complete Your Subscription</h3>
        <p>You've selected the <strong id="selected-tier-name">Professional</strong> tier for <strong id="selected-amount">25</strong> XRP per month.</p>
        
        <div class="button-group">
          <button class="pricing-button primary" onclick="createPaymentRequest()">
            <span id="create-btn-text">Create Payment Request</span>
            <span id="create-btn-loading" style="display: none;">
              <span class="loading-spinner"></span> Creating...
            </span>
          </button>
          <button class="pricing-button secondary" onclick="goBackToTiers()">
            Choose Different Plan
          </button>
        </div>
      </div>

      <!-- Step 2: Payment Instructions -->
      <div class="payment-step" id="step-2">
        <h3>Send XRP Payment</h3>
        <p>Send the exact amount to the address below using your XRP wallet:</p>
        
        <div class="payment-details">
          <div class="payment-field">
            <label>Destination Address</label>
            <input type="text" id="destination-address" readonly onclick="copyToClipboard(this)">
          </div>
          <div class="payment-field">
            <label>Amount</label>
            <input type="text" id="payment-amount" readonly onclick="copyToClipboard(this)">
          </div>
          <div class="payment-field">
            <label>Destination Tag (Required)</label>
            <input type="text" id="destination-tag" readonly onclick="copyToClipboard(this)">
          </div>
        </div>

        <div class="status-message status-loading">
          <span>⏱️</span>
          <span>Please send the payment and enter your transaction hash below</span>
        </div>

        <div class="payment-field">
          <label>Transaction Hash</label>
          <input type="text" id="transaction-hash" placeholder="Enter your XRP transaction hash">
        </div>

        <div class="button-group">
          <button class="pricing-button primary" onclick="verifyPayment()">
            <span id="verify-btn-text">Verify Payment</span>
            <span id="verify-btn-loading" style="display: none;">
              <span class="loading-spinner"></span> Verifying...
            </span>
          </button>
          <button class="pricing-button secondary" onclick="goBackToStep1()">
            Back
          </button>
        </div>
      </div>

      <!-- Step 3: Confirmation -->
      <div class="payment-step" id="step-3">
        <div id="success-message" class="status-message status-success" style="display: none;">
          <span>🎉</span>
          <span>Payment verified! Your subscription is now active.</span>
        </div>
        
        <div id="error-message" class="status-message status-error" style="display: none;">
          <span>❌</span>
          <span id="error-details">Payment verification failed. Please try again.</span>
        </div>

        <div class="button-group">
          <a href="/dashboard" class="pricing-button primary" id="dashboard-btn" style="display: none; text-decoration: none; text-align: center;">
            Access Dashboard
          </a>
          <button class="pricing-button secondary" onclick="tryAgain()" id="retry-btn" style="display: none;">
            Try Again
          </button>
        </div>
      </div>
    </div>

    <!-- Legacy Access Code -->
    <div style="margin-top: var(--space-12); padding-top: var(--space-8); border-top: 1px solid var(--color-border-primary); text-align: center;">
      <details style="max-width: 400px; margin: 0 auto;">
        <summary style="cursor: pointer; color: var(--color-text-secondary); font-size: var(--text-sm);">
          Have an access code? Click here
        </summary>
        <form method="post" action="/paywall/verify" style="margin-top: var(--space-4);">
          <div class="payment-field">
            <input type="text" name="code" placeholder="Enter access code" required>
          </div>
          <button type="submit" class="pricing-button secondary" style="width: auto; padding: var(--space-3) var(--space-6);">
            Verify Code
          </button>
        </form>
      </details>
    </div>
  </div>
</div>

<script>
let selectedTier = 2;
let selectedAmount = 25;
let paymentRequestId = null;

const tierNames = {
  1: 'Starter',
  2: 'Professional', 
  3: 'Enterprise'
};

function selectTier(tier, amount) {
  selectedTier = tier;
  selectedAmount = amount;
  
  // Update UI
  document.querySelectorAll('.pricing-card').forEach(card => {
    card.classList.remove('selected');
  });
  document.querySelector(`[data-tier="${tier}"]`).classList.add('selected');
  
  // Update payment flow
  document.getElementById('selected-tier-name').textContent = tierNames[tier];
  document.getElementById('selected-amount').textContent = amount;
  
  // Show payment flow
  document.getElementById('payment-flow').style.display = 'block';
  document.getElementById('payment-flow').scrollIntoView({ behavior: 'smooth' });
  
  // Reset to step 1
  showStep(1);
}

function showStep(step) {
  document.querySelectorAll('.payment-step').forEach(s => {
    s.classList.remove('active');
  });
  document.getElementById(`step-${step}`).classList.add('active');
}

function goBackToTiers() {
  document.getElementById('payment-flow').style.display = 'none';
  document.querySelector('.pricing-grid').scrollIntoView({ behavior: 'smooth' });
}

function goBackToStep1() {
  showStep(1);
}

async function createPaymentRequest() {
  const createBtn = document.getElementById('create-btn-text');
  const loadingBtn = document.getElementById('create-btn-loading');
  
  createBtn.style.display = 'none';
  loadingBtn.style.display = 'inline-flex';
  
  try {
    const response = await fetch('/api/paywall/xrp-payment', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        amount_xrp: selectedAmount,
        tier: selectedTier
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (data.success) {
      paymentRequestId = data.request_id;
      
      // Fill payment details
      document.getElementById('destination-address').value = data.destination_address;
      document.getElementById('payment-amount').value = `${selectedAmount} XRP`;
      document.getElementById('destination-tag').value = data.destination_tag;
      
      showStep(2);
    } else {
      throw new Error(data.error || 'Failed to create payment request');
    }
  } catch (error) {
    console.error('Payment request error:', error);
    showError('Failed to create payment request. Please try again.');
  } finally {
    createBtn.style.display = 'inline';
    loadingBtn.style.display = 'none';
  }
}

async function verifyPayment() {
  const transactionHash = document.getElementById('transaction-hash').value.trim();
  
  if (!transactionHash) {
    showError('Please enter your transaction hash');
    return;
  }
  
  const verifyBtn = document.getElementById('verify-btn-text');
  const loadingBtn = document.getElementById('verify-btn-loading');
  
  verifyBtn.style.display = 'none';
  loadingBtn.style.display = 'inline-flex';
  
  try {
    const response = await fetch('/api/paywall/verify-payment', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        request_id: paymentRequestId,
        transaction_hash: transactionHash
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    showStep(3);
    
    if (data.success) {
      document.getElementById('success-message').style.display = 'flex';
      document.getElementById('dashboard-btn').style.display = 'inline-block';
      document.getElementById('error-message').style.display = 'none';
      document.getElementById('retry-btn').style.display = 'none';
    } else {
      document.getElementById('error-message').style.display = 'flex';
      document.getElementById('error-details').textContent = data.error || 'Payment verification failed';
      document.getElementById('retry-btn').style.display = 'inline-block';
      document.getElementById('success-message').style.display = 'none';
      document.getElementById('dashboard-btn').style.display = 'none';
    }
  } catch (error) {
    console.error('Payment verification error:', error);
    showStep(3);
    document.getElementById('error-message').style.display = 'flex';
    document.getElementById('error-details').textContent = 'Network error. Please try again.';
    document.getElementById('retry-btn').style.display = 'inline-block';
    document.getElementById('success-message').style.display = 'none';
    document.getElementById('dashboard-btn').style.display = 'none';
  } finally {
    verifyBtn.style.display = 'inline';
    loadingBtn.style.display = 'none';
  }
}

function tryAgain() {
  showStep(2);
  document.getElementById('transaction-hash').value = '';
}

function copyToClipboard(input) {
  input.select();
  document.execCommand('copy');
  
  // Show feedback
  const originalBg = input.style.background;
  input.style.background = 'var(--color-success-100)';
  setTimeout(() => {
    input.style.background = originalBg;
  }, 500);
}

function showError(message) {
  // Create temporary error notification
  const notification = document.createElement('div');
  notification.className = 'status-message status-error';
  notification.innerHTML = `<span>❌</span><span>${message}</span>`;
  notification.style.position = 'fixed';
  notification.style.top = '20px';
  notification.style.right = '20px';
  notification.style.zIndex = '9999';
  notification.style.maxWidth = '400px';
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

// Auto-select popular tier on load
document.addEventListener('DOMContentLoaded', function() {
  // Pre-select the Professional tier
  selectTier(2, 25);
  document.getElementById('payment-flow').style.display = 'none';
});
</script>
{% endblock %}