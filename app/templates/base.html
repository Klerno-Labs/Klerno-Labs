<!doctype html>
<html lang="en" data-app="klerno">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#7b6cff" />
  <meta name="description" content="Klerno Labs - AML Risk Intelligence for XRPL & beyond. Real-time transaction tagging, risk scoring, and compliance automation." />
  <title>{{ title or "Klerno Labs" }}</title>
  
  <!-- Preload critical resources -->
  <link rel="preload" href="{{ url_path_for('static', path='css/app.css') }}" as="style" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />

  <!-- Bootstrap 5 with enhanced fallback handling -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
    data-fallback="{{ url_path_for('static', path='css/bootstrap.min.css') }}"
    onerror="this.removeAttribute('onerror'); this.href=this.dataset.fallback"
  />

  <!-- Enhanced app styles with accessibility improvements -->
  <link rel="stylesheet" href="{{ url_path_for('static', path='css/app.css') }}" />

  <!-- Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Enhanced CSS variables and base styles -->
  <style>
    /* Skip to content for screen readers */
    .skip-to-content {
      position: absolute;
      top: -40px;
      left: 6px;
      background: var(--accent-primary);
      color: white;
      padding: 8px;
      text-decoration: none;
      border-radius: 4px;
      z-index: 100;
      transition: top 0.2s ease;
    }
    .skip-to-content:focus {
      top: 6px;
    }
    
    /* Enhanced dark theme variables */
    :root {
      --bg: #060913;
      --panel: #121a34;
      --line: #1e2a52;
      --ink: #f1f5f9;
      --muted: #cbd5e1;
      --brand: #7b6cff;
      --danger: #ef4444;
      --ok: #22c55e;
      --warn: #fbbf24;
    }
    
    /* Base body styles with improved accessibility */
    body {
      background: var(--bg);
      color: var(--ink);
      line-height: 1.6;
      font-feature-settings: "kern" 1, "liga" 1;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Enhanced focus management */
    *:focus {
      outline: 2px solid var(--brand);
      outline-offset: 2px;
    }
    
    /* Improved card styling */
    .border-line { border-color: var(--line) !important; }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 20px;
      transition: all 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    
    /* Enhanced interactive elements */
    .chip {
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
      border-radius: 12px;
      padding: 0.5rem 1rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
      text-decoration: none;
      color: inherit;
    }
    .chip:hover {
      background: rgba(255,255,255,0.08);
      border-color: var(--brand);
      color: var(--brand);
      transform: translateY(-1px);
    }
    
    .pill {
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    /* Enhanced navbar */
    .navbar .navbar-toggler-icon {
      filter: invert(1);
    }
    
    /* Improved accessibility for navigation */
    .navbar-nav .nav-link {
      min-height: 44px;
      display: flex;
      align-items: center;
    }
    
    /* Loading states */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    /* Animation for page transitions */
    .page-transition {
      animation: fadeInUp 0.3s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Print styles */
    @media print {
      .navbar, .skip-to-content {
        display: none !important;
      }
      body {
        background: white !important;
        color: black !important;
      }
      .card {
        border: 1px solid #ccc !important;
        box-shadow: none !important;
      }
    }
  </style>
</head>

<body class="min-vh-100 d-flex flex-column">
  <!-- Skip to content link for accessibility -->
  <a href="#main-content" class="skip-to-content">Skip to main content</a>

  <!-- Enhanced header with improved semantics -->
  <header class="border-bottom border-line sticky-top" style="backdrop-filter:saturate(140%) blur(8px); background:rgba(0,0,0,.25)" role="banner">
    <nav class="navbar navbar-expand-lg" aria-label="Primary navigation">
      <div class="container-fluid">
        <a href="{{ url_path_for('ui_dashboard') }}" class="navbar-brand text-light fw-semibold d-flex align-items-center gap-2" aria-label="Klerno Labs home">
          <span class="d-inline-block bg-gradient rounded-circle" style="width:32px;height:32px;background:var(--brand)!important;"></span>
          Klerno Labs
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
                aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation menu">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div id="mainNav" class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto gap-2" role="menubar">
            <li class="nav-item" role="menuitem">
              <a id="nav-dashboard" class="nav-link text-light chip" href="{{ url_path_for('ui_dashboard') }}" aria-current="{% if request.url.path == '/dashboard' %}page{% endif %}">
                <span aria-hidden="true">ðŸ“Š</span> Dashboard
              </a>
            </li>
            <li class="nav-item" role="menuitem">
              <a id="nav-alerts" class="nav-link text-light chip" href="{{ url_path_for('ui_alerts') }}" aria-current="{% if request.url.path == '/alerts' %}page{% endif %}">
                <span aria-hidden="true">ðŸš¨</span> Alerts
              </a>
            </li>
            <li class="nav-item" role="menuitem">
              <a class="nav-link text-light chip" href="/docs" target="_blank" rel="noopener" aria-describedby="api-docs-desc">
                <span aria-hidden="true">ðŸ“š</span> API Docs
              </a>
              <span id="api-docs-desc" class="sr-only">Opens in a new window</span>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <!-- Enhanced main content area -->
  <main id="main-content" class="container flex-grow-1 py-4 page-transition" role="main" tabindex="-1">
    {% block content %}{% endblock %}
  </main>

  <!-- Enhanced footer with better semantics -->
  <footer class="container pb-4" style="color:var(--muted)" role="contentinfo">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="d-flex align-items-center gap-3">
        <span>Â© {{ (now().year if now else 2025) }} Klerno Labs</span>
        <span class="opacity-75">XRPL-first Risk Intelligence</span>
      </div>
      <div class="d-flex gap-3">
        <a href="/privacy" class="text-decoration-none opacity-75 hover-opacity-100">Privacy</a>
        <a href="/terms" class="text-decoration-none opacity-75 hover-opacity-100">Terms</a>
        <a href="/support" class="text-decoration-none opacity-75 hover-opacity-100">Support</a>
      </div>
    </div>
  </footer>

  <!-- Enhanced link management with accessibility -->
  <script>
  (function enhancedLinkManagement(){
    try {
      const params = new URLSearchParams(window.location.search);
      const key = params.get("key");
      
      if (!key) return;
      
      // Attach key to internal links with better error handling
      document.querySelectorAll('a[href^="/"]').forEach(link => {
        try {
          const url = new URL(link.getAttribute("href"), window.location.origin);
          url.searchParams.set("key", key);
          link.setAttribute("href", url.toString());
        } catch (e) {
          console.warn('Failed to process link:', link.href, e);
        }
      });
    } catch (e) {
      console.warn('Link management failed:', e);
    }
  })();
  
  // Enhanced accessibility features
  (function accessibilityEnhancements() {
    // Add focus management for skip links
    const skipLink = document.querySelector('.skip-to-content');
    const mainContent = document.querySelector('#main-content');
    
    if (skipLink && mainContent) {
      skipLink.addEventListener('click', (e) => {
        e.preventDefault();
        mainContent.focus();
        mainContent.scrollIntoView();
      });
    }
    
    // Enhance keyboard navigation
    document.addEventListener('keydown', (e) => {
      // Press 'Escape' to close mobile menu
      if (e.key === 'Escape') {
        const mobileMenu = document.querySelector('#mainNav');
        const toggleButton = document.querySelector('.navbar-toggler');
        
        if (mobileMenu && mobileMenu.classList.contains('show')) {
          toggleButton?.click();
        }
      }
    });
    
    // Add loading states for async actions
    document.addEventListener('click', (e) => {
      const button = e.target.closest('button, .btn');
      if (button && button.type === 'submit') {
        button.classList.add('loading');
        button.setAttribute('aria-busy', 'true');
        
        // Remove loading state after form submission
        setTimeout(() => {
          button.classList.remove('loading');
          button.removeAttribute('aria-busy');
        }, 2000);
      }
    });
    
    // Announce page changes to screen readers
    const announcer = document.createElement('div');
    announcer.setAttribute('aria-live', 'polite');
    announcer.setAttribute('aria-atomic', 'true');
    announcer.className = 'sr-only';
    document.body.appendChild(announcer);
    
    // Monitor for page title changes and announce them
    const titleObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'childList' && mutation.target === document.head) {
          const title = document.title;
          if (title) {
            announcer.textContent = `Page changed to: ${title}`;
          }
        }
      });
    });
    
    titleObserver.observe(document.head, {
      childList: true,
      subtree: true
    });
  })();
  </script>

  <!-- Bootstrap Bundle with enhanced error handling -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
    data-fallback="{{ url_path_for('static', path='js/bootstrap.bundle.min.js') }}"
    onerror="this.removeAttribute('onerror'); this.src=this.dataset.fallback">
  </script>

  <!-- Real-time optimization utilities -->
  <script src="{{ url_path_for('static', path='js/optimization.js') }}"></script>

  {% block scripts %}{% endblock %}
</body>
</html>
